{% extends 'users/base_auth.html' %}
{% load static %}
{% block title %}Changement de mot de passe - MTN CI{% endblock %}
{% block header_title %}Changement de mot de passe{% endblock %}
{% block header_subtitle %}Mettez à jour votre mot de passe pour sécuriser votre compte{% endblock %}
{% block content %}
{% if messages %}
    {% for message in messages %}
        <div class="spectrum-Alert{% if message.tags %} spectrum-Alert--{{ message.tags }}{% endif %}" role="alert">
            <svg class="spectrum-Icon spectrum-Alert-icon" focusable="false" aria-hidden="true">
                {% if 'error' in message.tags %}
                    <use href="#spectrum-icon-Alert" />
                {% elif 'success' in message.tags %}
                    <use href="#spectrum-icon-CheckmarkCircle" />
                {% else %}
                    <use href="#spectrum-icon-Info" />
                {% endif %}
            </svg>
            <div class="spectrum-Alert-header">{{ message }}</div>
        </div>
    {% endfor %}
{% endif %}

<form method="post" id="changePasswordForm" class="auth-form spectrum-Form spectrum-Form--labelsLeft">
    {% csrf_token %}
    
    <div class="spectrum-Form-item">
        <label for="id_old_password" class="auth-label spectrum-Form-itemLabel spectrum-FieldLabel">
            <svg class="auth-label-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M12 1a7 7 0 0 1 7 7v3h1a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h1V8a7 7 0 0 1 7-7zm0 4a3 3 0 0 0-3 3v3h6V8a3 3 0 0 0-3-3z"/>
            </svg>
            Ancien mot de passe
        </label>
        <div class="spectrum-Form-itemField input-with-action">
            <input 
                type="password" 
                class="auth-input spectrum-Textfield"
                id="id_old_password" 
                name="old_password" 
                placeholder="Entrez votre ancien mot de passe"
                required
                autofocus
            >
            <button type="button" class="toggle-password spectrum-Button spectrum-Button--sizeS" data-target="id_old_password" aria-label="Voir le mot de passe">
                <svg class="auth-toggle-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9z"/>
                </svg>
            </button>
        </div>
        {% if form.old_password.errors %}
            <div class="spectrum-HelpText spectrum-HelpText--validation">
                {% for error in form.old_password.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
    </div>

    <div class="spectrum-Form-item">
        <label for="id_new_password1" class="auth-label spectrum-Form-itemLabel spectrum-FieldLabel">
            <svg class="auth-label-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M18 8h-1V6a5 5 0 0 0-10 0v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2zm-6 9a2 2 0 1 1 0-4a2 2 0 0 1 0 4zm3.1-9H8.9V6a3.1 3.1 0 0 1 6.2 0v2z"/>
            </svg>
            Nouveau mot de passe
        </label>
        <div class="spectrum-Form-itemField input-with-action">
            <input 
                type="password" 
                class="auth-input spectrum-Textfield"
                id="id_new_password1" 
                name="new_password1" 
                placeholder="Entrez votre nouveau mot de passe"
                required
            >
            <button type="button" class="toggle-password spectrum-Button spectrum-Button--sizeS" data-target="id_new_password1" aria-label="Voir le mot de passe">
                <svg class="auth-toggle-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9z"/>
                </svg>
            </button>
        </div>
        {% if form.new_password1.errors %}
            <div class="spectrum-HelpText spectrum-HelpText--validation">
                {% for error in form.new_password1.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
        
        <!-- Indicateurs de force du mot de passe -->
        <div class="password-strength" id="passwordStrength" style="margin-top: 8px;">
            <div class="spectrum-ProgressBar spectrum-ProgressBar--sizeM" style="width: 100%;">
                <div class="spectrum-ProgressBar-bar" role="progressbar" style="width: 0%;" id="strengthBar"></div>
            </div>
            <div class="spectrum-HelpText" id="strengthText" style="margin-top: 4px;"></div>
        </div>
    </div>

    <div class="spectrum-Form-item">
        <label for="id_new_password2" class="auth-label spectrum-Form-itemLabel spectrum-FieldLabel">
            <svg class="auth-label-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M18 8h-1V6a5 5 0 0 0-10 0v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2zm-6 9a2 2 0 1 1 0-4a2 2 0 0 1 0 4zm3.1-9H8.9V6a3.1 3.1 0 0 1 6.2 0v2z"/>
            </svg>
            Confirmer le mot de passe
        </label>
        <div class="spectrum-Form-itemField input-with-action">
            <input 
                type="password" 
                class="auth-input spectrum-Textfield"
                id="id_new_password2" 
                name="new_password2" 
                placeholder="Confirmez votre nouveau mot de passe"
                required
            >
            <button type="button" class="toggle-password spectrum-Button spectrum-Button--sizeS" data-target="id_new_password2" aria-label="Voir le mot de passe">
                <svg class="auth-toggle-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9z"/>
                </svg>
            </button>
        </div>
        {% if form.new_password2.errors %}
            <div class="spectrum-HelpText spectrum-HelpText--validation">
                {% for error in form.new_password2.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
    </div>

    <!-- Exigences du mot de passe -->
    <div class="spectrum-Well" style="margin: 20px 0; padding: 16px;">
        <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #4b5563;">Exigences de sécurité :</h3>
        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #6b7280;">
            <li id="req-length">Au moins 12 caractères</li>
            <li id="req-upper">Au moins une lettre majuscule</li>
            <li id="req-lower">Au moins une lettre minuscule</li>
            <li id="req-digit">Au moins un chiffre</li>
            <li id="req-special">Au moins un caractère spécial (* @ ! - _ /)</li>
        </ul>
    </div>

    <div class="spectrum-Form-item" style="margin-top: 24px;">
        <button type="submit" class="spectrum-Button spectrum-Button--sizeM spectrum-Button--accent" style="width: 100%;">
            <span class="spectrum-Button-label">Changer le mot de passe</span>
        </button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des boutons afficher/masquer le mot de passe
    const toggleButtons = document.querySelectorAll('.toggle-password');
    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const input = document.getElementById(targetId);
            
            if (input.type === 'password') {
                input.type = 'text';
                this.innerHTML = '<svg class="auth-toggle-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 7a5 5 0 0 1 5 5c0 1.38-.56 2.63-1.46 3.54l1.42 1.42A6.98 6.98 0 0 0 19 12a7 7 0 0 0-7-7c-1.95 0-3.73.8-5 2.09l1.42 1.42A4.96 4.96 0 0 1 12 7zm-7 0l1.41 1.41L2 12.83L.59 11.41L5 7zm7 0a5 5 0 0 0-5 5c0 1.38.56 2.63 1.46 3.54l1.42 1.42A6.98 6.98 0 0 0 5 12a7 7 0 0 1 7-7c1.95 0 3.73.8 5 2.09l-1.42 1.42A4.96 4.96 0 0 0 12 7z"/></svg>';
            } else {
                input.type = 'password';
                this.innerHTML = '<svg class="auth-toggle-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9z"/></svg>';
            }
        });
    });

    // Validation du mot de passe en temps réel
    const passwordInput = document.getElementById('id_new_password1');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    
    const requirements = {
        length: { regex: /.{12,}/, element: document.getElementById('req-length') },
        upper: { regex: /[A-Z]/, element: document.getElementById('req-upper') },
        lower: { regex: /[a-z]/, element: document.getElementById('req-lower') },
        digit: { regex: /\d/, element: document.getElementById('req-digit') },
        special: { regex: /[*@!-_\/]/, element: document.getElementById('req-special') }
    };

    function checkPasswordStrength(password) {
        let score = 0;
        
        for (const [key, req] of Object.entries(requirements)) {
            if (req.regex.test(password)) {
                score++;
                req.element.style.color = '#059669';
                req.element.style.textDecoration = 'line-through';
            } else {
                req.element.style.color = '#6b7280';
                req.element.style.textDecoration = 'none';
            }
        }
        
        // Mettre à jour la barre de progression
        const percentage = (score / 5) * 100;
        strengthBar.style.width = percentage + '%';
        
        if (score <= 2) {
            strengthBar.style.backgroundColor = '#ef4444';
            strengthText.textContent = 'Faible';
            strengthText.style.color = '#ef4444';
        } else if (score <= 4) {
            strengthBar.style.backgroundColor = '#f59e0b';
            strengthText.textContent = 'Moyen';
            strengthText.style.color = '#f59e0b';
        } else {
            strengthBar.style.backgroundColor = '#10b981';
            strengthText.textContent = 'Fort';
            strengthText.style.color = '#10b981';
        }
    }

    passwordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
    });
});
</script>
{% endblock %}
