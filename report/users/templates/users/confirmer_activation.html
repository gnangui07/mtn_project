{% extends 'users/base_auth.html' %}
{% load static %}

{% block title %}Créer votre mot de passe - MTN CI{% endblock %}

{% block header_title %}Créer votre mot de passe{% endblock %}
{% block header_subtitle %}Dernière étape pour accéder à CAPEX Works Valuation{% endblock %}

{% block content %}
<div class="mb-4 rounded-lg bg-green-50 text-green-900 p-3">
    Identifiants vérifiés. Créez maintenant votre mot de passe sécurisé pour finaliser l'activation de votre compte.
    </div>

<form method="post" id="confirmForm" class="auth-form spectrum-Form spectrum-Form--labelsLeft">
    {% csrf_token %}
    
    <div class="spectrum-Form-item">
        <label for="new_password" class="auth-label spectrum-Form-itemLabel spectrum-FieldLabel">
            <svg class="auth-label-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M12 1a7 7 0 0 1 7 7v3h1a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h1V8a7 7 0 0 1 7-7zm0 4a3 3 0 0 0-3 3v3h6V8a3 3 0 0 0-3-3z"/>
            </svg>
            Nouveau mot de passe
        </label>
        <div class="spectrum-Form-itemField input-with-action">
            <input 
                type="password" 
                class="auth-input spectrum-Textfield" 
                id="new_password" 
                name="new_password" 
                placeholder="Minimum 8 caractères"
                required
                autofocus
            >
            <button class="spectrum-Button spectrum-Button--sizeS" type="button" id="togglePassword1" aria-label="Voir le mot de passe">
                <svg class="auth-toggle-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9z"/>
                </svg>
            </button>
        </div>
        <div id="strengthBar" class="h-1 rounded bg-gray-200 mt-2"></div>
        <small id="strengthText" class="text-sm"></small>
        <div id="passwordErrors" class="mt-2"></div>
    </div>
    
    <div class="spectrum-Form-item">
        <label for="confirm_password" class="auth-label spectrum-Form-itemLabel spectrum-FieldLabel">
            <svg class="auth-label-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M12 1a7 7 0 0 1 7 7v3h1a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h1V8a7 7 0 0 1 7-7zm0 4a3 3 0 0 0-3 3v3h6V8a3 3 0 0 0-3-3z"/>
            </svg>
            Confirmer le mot de passe
        </label>
        <div class="spectrum-Form-itemField input-with-action">
            <input 
                type="password" 
                class="auth-input spectrum-Textfield" 
                id="confirm_password" 
                name="confirm_password" 
                placeholder="Retapez votre mot de passe"
                required
            >
            <button class="spectrum-Button spectrum-Button--sizeS" type="button" id="togglePassword2" aria-label="Voir le mot de passe">
                <svg class="auth-toggle-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9z"/>
                </svg>
            </button>
        </div>
        <small id="matchText" class="text-sm"></small>
        <div id="confirmErrors" class="mt-2"></div>
    </div>
    
    <button type="submit" class="auth-submit spectrum-Button spectrum-Button--cta spectrum-Button--sizeM" id="submitBtn" disabled>
        <span class="spectrum-Button-label">Activer mon compte</span>
    </button>
</form>
{% endblock %}

{% block extra_js %}
<script>
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    const matchText = document.getElementById('matchText');
    const submitBtn = document.getElementById('submitBtn');
    const passwordErrors = document.getElementById('passwordErrors');
    const confirmErrors = document.getElementById('confirmErrors');
    (function() {
        const EYE = '<svg class="auth-toggle-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9z"/></svg>';
        const EYE_OFF = '<svg class="auth-toggle-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M2 12c1.73-4.39 6-7.5 11-7.5c2.31 0 4.48.6 6.37 1.67l1.46-1.46l1.41 1.41l-19 19l-1.41-1.41l3.1-3.1C3.5 18.29 2.42 15.27 2 12zm7.28-.86l3.58 3.58A4.5 4.5 0 0 0 9.28 11.14zM12 17.5c1.03 0 2-.2 2.9-.56l-2.64-2.64A4.48 4.48 0 0 1 12 17.5z"/></svg>';
        function wireToggle(btnId, inputId) {
            const btn = document.getElementById(btnId);
            const input = document.getElementById(inputId);
            btn.addEventListener('click', function() {
                const show = input.type === 'password';
                input.type = show ? 'text' : 'password';
                btn.setAttribute('aria-label', show ? 'Cacher le mot de passe' : 'Voir le mot de passe');
                btn.innerHTML = show ? EYE_OFF : EYE;
            });
        }
        wireToggle('togglePassword1', 'new_password');
        wireToggle('togglePassword2', 'confirm_password');
    })();
    newPasswordInput.addEventListener('input', function() {
        const password = this.value;
        let strength = 0;
        let errors = [];
        const checks = {
            length: { test: password.length >= 8, message: 'Au moins 8 caractères' },
            uppercase: { test: /[A-Z]/.test(password), message: 'Au moins une majuscule' },
            lowercase: { test: /[a-z]/.test(password), message: 'Au moins une minuscule' },
            number: { test: /[0-9]/.test(password), message: 'Au moins un chiffre' },
            special: { test: /[!@#$%^&*(),.?":{}|<>]/.test(password), message: 'Au moins un caractère spécial (!@#$%^&*)' }
        };
        for (const [key, check] of Object.entries(checks)) {
            if (check.test) {
                strength++;
            } else if (password.length > 0) {
                errors.push(check.message);
            }
        }
        if (errors.length > 0 && password.length > 0) {
            passwordErrors.innerHTML = `<div class="mb-2 rounded-lg bg-red-50 text-red-900 p-3 text-sm"><strong>Critères manquants :</strong><ul class="list-disc pl-5">${errors.map(err => `<li>${err}</li>`).join('')}</ul></div>`;
        } else {
            passwordErrors.innerHTML = '';
        }
        if (password.length === 0) {
            strengthBar.className = 'h-1 rounded bg-gray-200 mt-2';
            strengthText.textContent = '';
            strengthText.className = 'text-sm';
        } else if (strength < 3) {
            strengthBar.className = 'h-1 rounded bg-red-500 mt-2';
            strengthText.textContent = 'Mot de passe faible';
            strengthText.className = 'text-sm text-red-600';
        } else if (strength < 5) {
            strengthBar.className = 'h-1 rounded bg-yellow-400 mt-2';
            strengthText.textContent = 'Mot de passe moyen';
            strengthText.className = 'text-sm text-yellow-600';
        } else {
            strengthBar.className = 'h-1 rounded bg-green-500 mt-2';
            strengthText.textContent = 'Mot de passe fort ✓';
            strengthText.className = 'text-sm text-green-600';
        }
        checkFormValidity();
    });
    confirmPasswordInput.addEventListener('input', function() {
        const password = newPasswordInput.value;
        const confirm = this.value;
        if (confirm === '') {
            matchText.textContent = '';
            matchText.className = 'text-sm';
            confirmErrors.innerHTML = '';
        } else if (password === confirm) {
            matchText.textContent = '✓ Les mots de passe correspondent';
            matchText.className = 'text-sm text-green-600';
            confirmErrors.innerHTML = '';
        } else {
            matchText.textContent = '';
            matchText.className = 'text-sm';
            confirmErrors.innerHTML = `<div class="mb-2 rounded-lg bg-yellow-50 text-yellow-900 p-3 text-sm">Les mots de passe ne correspondent pas</div>`;
        }
        checkFormValidity();
    });
    function checkFormValidity() {
        const password = newPasswordInput.value;
        const confirm = confirmPasswordInput.value;
        const isValid = password.length >= 8 &&
                       /[A-Z]/.test(password) &&
                       /[a-z]/.test(password) &&
                       /[0-9]/.test(password) &&
                       /[!@#$%^&*(),.?":{}|<>]/.test(password) &&
                       password === confirm;
        submitBtn.disabled = !isValid;
    }
</script>
{% endblock %}
