{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Timeline Delays{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-clock me-2"></i>Timeline Delays Management</h2>
        {% if fichier_id %}
        <a href="{% url 'orders:details_bon' bon_id=fichier_id %}?selected_order_number={{ data.po_number }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back
        </a>
        {% else %}
        <a href="{% url 'orders:accueil' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back
        </a>
        {% endif %}
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-bordered">
            <thead style="background-color: #FFCC00; color: #000;">
                <tr>
                    <th>Purchase Order</th>
                    <th>Supplier</th>
                    <th class="text-center">Nombre Total de Jours de Retard</th>
                    <th class="text-center">Part MTN</th>
                    <th class="text-center">Part Force Majeure</th>
                    <th class="text-center">Part Fournisseur</th>
                    <th class="text-center">Montant PO</th>
                    <th class="text-center">Montant Rétention Timeline</th>
                    <th class="text-center">Taux Rétention Timeline (%)</th>
                    <th class="text-center">Action</th>
                </tr>
            </thead>
            <tbody>
                <tr id="row-{{ data.id }}">
                    <td><strong>{{ data.po_number }}</strong></td>
                    <td>{{ data.supplier }}</td>
                    <td class="text-center"><span class="badge bg-secondary">{{ data.total_days_late }}</span></td>
                    <td class="text-center">
                        <input type="number" class="form-control form-control-sm text-center" 
                               value="{{ data.delay_part_mtn }}" 
                               min="0" max="{{ data.total_days_late }}"
                               data-id="{{ data.id }}" data-field="mtn"
                               onchange="updateVendor()">
                    </td>
                    <td class="text-center">
                        <input type="number" class="form-control form-control-sm text-center" 
                               value="{{ data.delay_part_force_majeure }}" 
                               min="0" max="{{ data.total_days_late }}"
                               data-id="{{ data.id }}" data-field="fm"
                               onchange="updateVendor()">
                    </td>
                    <td class="text-center">
                        <strong id="vendor-{{ data.id }}">{{ data.delay_part_vendor }}</strong>
                    </td>
                    <td class="text-center">
                        <strong id="po-amount-{{ data.id }}">{{ data.po_amount|floatformat:2|intcomma }}</strong>
                    </td>
                    <td class="text-center">
                        <strong id="retention-amount-timeline-{{ data.id }}" class="text-danger">{{ data.retention_amount_timeline|floatformat:2|intcomma }}</strong>
                    </td>
                    <td class="text-center">
                        <strong id="retention-rate-timeline-{{ data.id }}" class="text-danger">{{ data.retention_rate_timeline|floatformat:2 }}%</strong>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm" style="background-color: #FFCC00; color: #000; border: 1px solid #000;" 
                                onclick="save()">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Section Commentaires/Observations -->
    <div class="card mt-4">
        <div class="card-header" style="background-color: #FFCC00; color: #000;">
            <h5 class="mb-0"><i class="fas fa-comment-alt me-2"></i>Commentaires et Observations</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Commentaire Part MTN -->
                <div class="col-md-4 mb-3">
                    <label for="comment-mtn" class="form-label fw-bold">
                        <i class="fas fa-building me-1"></i>Commentaire Part MTN <span class="text-danger">*</span>
                    </label>
                    <textarea id="comment-mtn" class="form-control" rows="4" required
                              placeholder="Saisir les observations concernant les retards dus à MTN...">{{ data.comment_mtn }}</textarea>
                    <small class="text-muted">Expliquez les raisons des {{ data.delay_part_mtn }} jours de retard MTN</small>
                </div>

                <!-- Commentaire Part Force Majeure -->
                <div class="col-md-4 mb-3">
                    <label for="comment-force-majeure" class="form-label fw-bold">
                        <i class="fas fa-exclamation-triangle me-1"></i>Commentaire Part Force Majeure <span class="text-danger">*</span>
                    </label>
                    <textarea id="comment-force-majeure" class="form-control" rows="4" required
                              placeholder="Saisir les observations concernant les cas de force majeure...">{{ data.comment_force_majeure }}</textarea>
                    <small class="text-muted">Expliquez les raisons des {{ data.delay_part_force_majeure }} jours de force majeure</small>
                </div>

                <!-- Commentaire Part Fournisseur -->
                <div class="col-md-4 mb-3">
                    <label for="comment-vendor" class="form-label fw-bold">
                        <i class="fas fa-truck me-1"></i>Commentaire Part Fournisseur <span class="text-danger">*</span>
                    </label>
                    <textarea id="comment-vendor" class="form-control" rows="4" required
                              placeholder="Saisir les observations concernant les retards dus au fournisseur...">{{ data.comment_vendor }}</textarea>
                    <small class="text-muted">Expliquez les raisons des <span id="vendor-days-display">{{ data.delay_part_vendor }}</span> jours de retard fournisseur</small>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-md-4 mb-3">
                    <label for="quotite-realisee" class="form-label fw-bold">
                        <i class="fas fa-percentage me-1"></i>Quotité réalisée (%)
                    </label>
                    <input type="number" id="quotite-realisee" class="form-control" min="0" max="100" step="0.01"
                           value="{{ data.quotite_realisee|floatformat:2 }}">
                    <small class="text-muted">Quotité non réalisée : <span id="quotite-non-realisee">{{ data.quotite_non_realisee|floatformat:2 }}</span>%</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
(function() {
    var evalId = parseInt('{{ data.id }}');
    var totalDays = parseInt('{{ data.total_days_late }}');
    var poAmount = parseFloat('{{ data.po_amount }}');
    var quotiteInput = document.getElementById('quotite-realisee');
    var quotiteNonRealiseeSpan = document.getElementById('quotite-non-realisee');
    var initialQuotite = parseFloat('{{ data.quotite_realisee|floatformat:2 }}') || 100;
    
    // Stocker les valeurs initiales
    var initialMtn = parseInt('{{ data.delay_part_mtn }}');
    var initialFm = parseInt('{{ data.delay_part_force_majeure }}');

    window.updateVendor = function() {
        var mtnInput = document.querySelector('[data-field="mtn"]');
        var fmInput = document.querySelector('[data-field="fm"]');
        var mtn = parseInt(mtnInput.value) || 0;
        var fm = parseInt(fmInput.value) || 0;
        
        // Validation : MTN + FM ne doit pas dépasser Total Days Late
        if (mtn + fm > totalDays) {
            Swal.fire({
                icon: 'error',
                title: 'Erreur de saisie',
                text: 'La somme de Part MTN (' + mtn + ') et Part Force Majeure (' + fm + ') ne peut pas dépasser le nombre total de jours de retard (' + totalDays + ').',
                confirmButtonColor: '#d33'
            });
            // Réinitialiser les inputs aux valeurs précédentes
            mtnInput.value = initialMtn;
            fmInput.value = initialFm;
            return;
        }
        
        // Mettre à jour les valeurs initiales si la validation passe
        initialMtn = mtn;
        initialFm = fm;
        
        var vendor = Math.max(0, totalDays - mtn - fm);
        document.getElementById('vendor-' + evalId).textContent = vendor;
        
        // Mettre à jour l'affichage des jours dans le commentaire fournisseur
        var vendorDaysDisplay = document.getElementById('vendor-days-display');
        if (vendorDaysDisplay) {
            vendorDaysDisplay.textContent = vendor;
        }
        
        // Calculer le montant de rétention timeline : PO Amount * 0.3% * Part Fournisseur
        var retentionAmountTimeline = poAmount * 0.003 * vendor;
        
        // Calculer le taux de rétention timeline
        var retentionRateTimeline = 0;
        if (poAmount > 0) {
            retentionRateTimeline = (retentionAmountTimeline / poAmount) * 100;
            // Si > 10%, recalculer le montant et fixer le taux à 10%
            if (retentionRateTimeline > 10) {
                retentionAmountTimeline = poAmount * 0.10;
                retentionRateTimeline = 10;
            }
        }
        
        // Mettre à jour l'affichage avec séparateurs de milliers
        document.getElementById('retention-amount-timeline-' + evalId).textContent = formatNumber(retentionAmountTimeline);
        document.getElementById('retention-rate-timeline-' + evalId).textContent = retentionRateTimeline.toFixed(2) + '%';

        updateQuotite();
    };

    // Fonction pour formater les nombres avec séparateurs de milliers
    function formatNumber(num) {
        return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    function updateQuotite() {
        if (!quotiteInput || !quotiteNonRealiseeSpan) return;
        var value = parseFloat(quotiteInput.value.replace(',', '.'));
        if (isNaN(value)) {
            quotiteNonRealiseeSpan.textContent = '0.00';
            return;
        }
        if (value < 0) {
            value = 0;
            quotiteInput.value = value.toFixed(2);
        } else if (value > 100) {
            value = 100;
            quotiteInput.value = value.toFixed(2);
        }
        var nonRealisee = Math.max(0, 100 - value);
        quotiteNonRealiseeSpan.textContent = nonRealisee.toFixed(2);
    }

    if (quotiteInput) {
        quotiteInput.addEventListener('input', updateQuotite);
        updateQuotite();
    }

    window.save = function() {
        var mtn = parseInt(document.querySelector('[data-field="mtn"]').value) || 0;
        var fm = parseInt(document.querySelector('[data-field="fm"]').value) || 0;
        var vendor = parseInt(document.getElementById('vendor-' + evalId).textContent) || 0;
        
        // Récupérer les commentaires
        var commentMtn = document.getElementById('comment-mtn').value.trim();
        var commentForceMajeure = document.getElementById('comment-force-majeure').value.trim();
        var commentVendor = document.getElementById('comment-vendor').value.trim();
        var quotiteValue = quotiteInput ? parseFloat(quotiteInput.value.replace(',', '.')) : initialQuotite;

        // Validation frontend
        if (!commentMtn || !commentForceMajeure || !commentVendor) {
            var missingFields = [];
            if (!commentMtn) missingFields.push('Commentaire Part MTN');
            if (!commentForceMajeure) missingFields.push('Commentaire Part Force Majeure');
            if (!commentVendor) missingFields.push('Commentaire Part Fournisseur');
            
            Swal.fire({
                icon: 'warning',
                title: 'Champs obligatoires manquants',
                html: 'Veuillez remplir les champs suivants :<br><strong>' + missingFields.join('<br>') + '</strong>',
                confirmButtonColor: '#FFCC00'
            });
            return;
        }

        if (isNaN(quotiteValue) || quotiteValue < 0 || quotiteValue > 100) {
            Swal.fire({
                icon: 'warning',
                title: 'Valeur invalide',
                text: 'La quotité réalisée doit être comprise entre 0 et 100%.',
                confirmButtonColor: '#FFCC00'
            });
            return;
        }

        fetch('/orders/api/update-delays/' + evalId + '/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                mtn: mtn, 
                fm: fm, 
                vendor: vendor,
                comment_mtn: commentMtn,
                comment_force_majeure: commentForceMajeure,
                comment_vendor: commentVendor,
                quotite: quotiteValue
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if(d.success) {
                if (quotiteInput && typeof d.quotite_realisee !== 'undefined') {
                    quotiteInput.value = parseFloat(d.quotite_realisee).toFixed(2);
                }
                if (quotiteNonRealiseeSpan && typeof d.quotite_non_realisee !== 'undefined') {
                    quotiteNonRealiseeSpan.textContent = parseFloat(d.quotite_non_realisee).toFixed(2);
                }
                Swal.fire({
                    icon: 'success',
                    title: 'Enregistré !',
                    text: 'Les retards et commentaires ont été mis à jour avec succès',
                    confirmButtonColor: '#FFCC00',
                    confirmButtonText: 'OK'
                });
            }
        })
        .catch(function(error) {
            // Gérer les erreurs de validation backend
            error.response?.json().then(function(errorData) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur de validation',
                    html: errorData.message || 'Échec de la sauvegarde',
                    confirmButtonColor: '#d33'
                });
            }).catch(function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur!',
                    text: 'Échec de la sauvegarde des retards',
                    confirmButtonColor: '#d33'
                });
            });
        });
    };

    function getCookie(name) {
        var v = null;
        if (document.cookie) {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var c = cookies[i].trim();
                if (c.substring(0, name.length + 1) === (name + '=')) {
                    v = decodeURIComponent(c.substring(name.length + 1));
                    break;
                }
            }
        }
        return v;
    }
})();
</script>
{% endblock %}
