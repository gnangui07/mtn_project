{% extends 'base.html' %}
{% load static %}
{% load orders_extras %}
{% load humanize %}
{% load i18n %}
{% block title %}Purchase Order Details: {{ bon_number }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'orders/css/detail_bon.css' %}">
{% endblock %}

{% block content %}
<main class="container-fluid mt-4 px-0" style="width: 100vw; max-width: 100vw; margin-left: 0; margin-right: 0;">

  <!-- 1. HEADER PRINCIPAL -->
  <header class="page-header">
    <h1><i class="fas fa-file-invoice"></i> Purchase Order: {{ bon_number }}</h1>
    <div class="meta-info">
      <span class="ms-2"><i class="far fa-calendar-alt"></i> 
        {% language 'en' %}
        {{ date_creation|date:"F d, Y H:i" }}
        {% endlanguage %}
      </span>
      <span class="ms-3"><i class="fas fa-coins"></i> PO AMOUNT: <strong>{{ montant_total|floatformat|intcomma }} {{ devise }}</strong></span>
      <span class="ms-3"><i class="fas fa-check-circle"></i> Amount Delivered: <strong class="montant-total-recue">{{ montant_total_recu|floatformat:0|intcomma }}</strong> {{ devise }}</span>
      <span class="ms-3"><i class="fas fa-list-ol"></i> Lines: {{ nb_lignes }}</span>
      <span class="ms-3"><i class="fas fa-exclamation-triangle"></i> Delivery Rate: <strong class="taux-avancement">{{ taux_avancement|floatformat:2 }}&#37;</strong></span>
      <span class="ms-3"><i class="fas fa-tag"></i> Status: 
        {% if statut %}
          {% if statut|upper == 'APPROVED' or statut|upper == 'COMPLETED' or statut|upper == 'CLOSED' %}
            <span class="badge bg-success">{{ statut }}</span>
          {% elif statut|upper == 'PENDING' or statut|upper == 'WAITING' or statut|upper == 'IN PROGRESS' %}
            <span class="badge bg-warning text-dark">{{ statut }}</span>
          {% elif statut|upper == 'REJECTED' or statut|upper == 'CANCELLED' or statut|upper == 'FAILED' %}
            <span class="badge bg-danger">{{ statut }}</span>
          {% else %}
            <span class="badge bg-info">{{ statut }}</span>
          {% endif %}
        {% else %}
          <span class="badge bg-secondary">Unknown</span>
        {% endif %}
      </span>
    </div>
    
    <!-- Bannière d'avertissement pour Migration IFS -->
    {% if is_migration_ifs %}
    <div class="alert alert-warning mt-3" role="alert">
      <i class="fas fa-lock me-2"></i>
      <strong>Read-Only Mode:</strong> This purchase order contains "Migration IFS" items. All actions are disabled. You can only view the information.
    </div>
    {% endif %}
    
    <div class="mt-3">
      <a href="{% url 'orders:reception' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i> Back to Register Delivery
      </a>
      
      <!-- Bouton d'exportation Excel avec données mises à jour -->
      <a href="{% url 'orders:export_bon_excel' bon_id=bon_id %}{% if selected_order_number %}?selected_order_number={{ selected_order_number }}{% endif %}" 
         class="btn btn-success ms-2 {% if is_migration_ifs %}disabled{% endif %}"
         {% if is_migration_ifs %}aria-disabled="true" onclick="return false;"{% endif %}
         title="Export Updated Excel">
        <i class="fas fa-file-excel me-2"></i> Export Delivery Report 
      </a>

      <!-- Bouton pour générer un rapport MSRN -->
      {% if bon_commande_id %}
      <button id="generate-msrn-btn" class="btn btn-primary ms-2 {% if is_migration_ifs %}disabled{% endif %}" 
              data-bon-id="{{ bon_commande_id }}"
              {% if is_migration_ifs %}disabled{% endif %}>
        <i class="fas fa-file-pdf me-2"></i> Generate MSRN
      </button>
      {% endif %}

      <!-- Ajouter après les autres boutons dans la section d'en-tête -->
      <button id="set-retention-btn" class="btn btn-info ms-2 {% if is_migration_ifs %}disabled{% endif %}" 
              data-retention-rate="{{ retention_rate|default:0 }}"
              data-retention-cause="{{ retention_cause|default:'' }}"
              {% if is_migration_ifs %}disabled{% endif %}>
          <i class="fas fa-exclamation-triangle me-2"></i> Define Retention on Payment 
      </button>

      <!-- Bouton pour générer l'évaluation fournisseur -->
      {% if bon_commande_id and supplier != 'N/A' %}
      <a href="{% url 'orders:vendor_evaluation' bon_commande_id=bon_commande_id %}?fichier_id={{ bon_id }}" 
         class="btn btn-warning ms-2 {% if is_migration_ifs %}disabled{% endif %}"
         {% if is_migration_ifs %}aria-disabled="true" onclick="return false;"{% endif %}>
        <i class="fas fa-star me-2"></i> Generate Vendor Evaluation
      </a>
      {% endif %}
      
      <!-- Bouton Timeline Delays -->
      {% if bon_commande_id %}
      <a href="{% url 'orders:timeline_delays' bon_commande_id=bon_commande_id %}?fichier_id={{ bon_id }}" 
         class="btn ms-2 {% if is_migration_ifs %}disabled{% endif %}" 
         style="background-color: #FFCC00; color: #000; border: 2px solid #000;"
         {% if is_migration_ifs %}aria-disabled="true" onclick="return false;"{% endif %}>
        <i class="fas fa-clock me-2"></i> Timeline Delays
      </a>
      {% endif %}
    </div>
  </header>

  <!-- 2. BARRE D'ONGLETS -->
  <section class="tabs-bar">
    <ul class="nav nav-tabs" id="poTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">PO Header</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="rawdata-tab" data-bs-toggle="tab" data-bs-target="#rawdata" type="button" role="tab">PO Lines Delivered Status</button>
      </li>
    </ul>
  </section>

  <!-- 3. CONTENU DES ONGLETS -->
  <section class="tab-content" style="margin: 0 15px;">
    
    <!-- 3.1 Onglet “Details PO” -->
    <div class="tab-pane fade show active" id="details" role="tabpanel">
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="info-card">
            <h5><i class="fas fa-info-circle"></i> Purchase Order Information</h5>
            <div class="info-item">
              <div class="info-label">Order Number:</div>
              <div class="info-value">{{ bon_number }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Supplier:</div>
              <div class="info-value">{{ supplier }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Currency:</div>
              <div class="info-value">{{ devise }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Creation Date:</div>
              <div class="info-value">
                {% language 'en' %}
                {{ date_creation|date:"F d, Y H:i" }}
                {% endlanguage %}
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">Status:</div>
              <div class="info-value">
                {% if statut %}
                  {% if statut|upper == 'APPROVED' or statut|upper == 'COMPLETED' or statut|upper == 'CLOSED' %}
                    <span class="badge bg-success">{{ statut }}</span>
                  {% elif statut|upper == 'PENDING' or statut|upper == 'WAITING' or statut|upper == 'IN PROGRESS' %}
                    <span class="badge bg-warning text-dark">{{ statut }}</span>
                  {% elif statut|upper == 'REJECTED' or statut|upper == 'CANCELLED' or statut|upper == 'FAILED' %}
                    <span class="badge bg-danger">{{ statut }}</span>
                  {% else %}
                    <span class="badge bg-info">{{ statut }}</span>
                  {% endif %}
                {% else %}
                  <span class="badge bg-secondary">Unknown</span>
                {% endif %}
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">PO AMOUNT:</div>
              <div class="info-value">{{ montant_total|floatformat|intcomma }} {{ devise }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Number of Lines:</div>
              <div class="info-value">{{ nb_lignes }}</div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="info-card">
            <h5><i class="fas fa-file-import"></i> Source File Details</h5>
            <div class="info-item">
              <div class="info-label">File ID:</div>
              <div class="info-value">{{ bon.id }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">File Name:</div>
              <div class="info-value">{{ bon.fichier.name|default:'N/A' }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">File Type:</div>
              <div class="info-value"><span class="badge badge-info">{{ extension|upper }}</span></div>
            </div>
            <div class="info-item">
              <div class="info-label">Import Date:</div>
              <div class="info-value">
                {% language 'en' %}
                {{ bon.date_importation|date:"F d, Y H:i" }}
                {% endlanguage %}
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">Imported By:</div>
              <div class="info-value">{{ bon.utilisateur.username|default:'System' }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">File Size:</div>
              <div class="info-value">{{ bon.fichier.size|filesizeformat|default:'N/A' }}</div>
            </div>
          </div>
        </div>
        {% if messages %}
        <div class="col-md-12">
          <div class="info-card">
            <h5><i class="fas fa-bell"></i> Notifications</h5>
            {% for message in messages %}
              <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- 3.2 Onglet “Raw Data” -->
    <div class="tab-pane fade" id="rawdata" role="tabpanel">
      <!-- 3.2.1 FILTRAGE / INDICATEUR -->
      <div class="alert alert-warning mb-4">
        <strong>Filtered view:</strong> Showing only lines with purchase order number 
        <span class="badge bg-warning text-dark">{{ bon_number }}</span>
      </div>

      <!-- 3.2.2 FILTRES DE LIVRAISON -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Delivery Filters</h6>
            </div>
            <div class="col-md-4 text-end">
              <div class="btn-group" role="group" aria-label="Delivery filters">
                <button type="button" class="btn btn-outline-primary btn-sm filter-btn active" data-filter="all">
                  <i class="fas fa-list me-1"></i> All Lines <span class="badge bg-secondary ms-1" id="count-all">{{ nb_lignes }}</span>
                </button>
                <button type="button" class="btn btn-outline-success btn-sm filter-btn" data-filter="partially-delivered">
                  <i class="fas fa-truck-loading me-1"></i> Partially Delivered <span class="badge bg-success ms-1" id="count-partial">0</span>
                </button>
                <button type="button" class="btn btn-outline-info btn-sm filter-btn" data-filter="fully-delivered">
                  <i class="fas fa-check-double me-1"></i> Fully Delivered <span class="badge bg-info ms-1" id="count-full">0</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 3.2.3 TABLEAU DES DONNÉES BRUTES -->
      <div class="card mb-0 card-data" style="width: 98vw; max-width: 98vw; margin-left: 0; margin-right: 0;">
        <div class="card-header bg-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-table me-2"></i>
              Raw Data <span class="badge bg-warning text-dark">{{ nb_lignes }} items</span>
            </h5>
            <button type="button" class="btn btn-sm btn-outline-primary" id="toggleColumnSelector">
              <i class="fas fa-columns me-1"></i> Select Columns
            </button>
          </div>
        </div>
        <div class="card-body p-0">
          <!-- Les styles ont été déplacés vers static/orders/css/detail_bon.css -->
          
          <div class="data-container">
            <!-- Bouton flottant pour Quantity Delivered collectif (initialement caché) -->
            {% if not is_migration_ifs %}
            <div id="collective-quantity-delivered-container" style="display: none; position: fixed; z-index: 1000; right: 30px; top: 120px;">
              <button id="apply-collective-quantity-delivered" class="btn btn-success btn-lg shadow">
                <i class="fas fa-check-circle me-2"></i> Quantity Delivered collectif <span id="selected-count-badge" class="badge bg-light text-dark ms-2">0</span>
              </button>
            </div>
            {% endif %}
            <table class="data-table" id="result_list">
              <thead>
                <tr>
                  <th style="width: 3%"><input type="checkbox" id="select-all-rows" {% if is_migration_ifs %}disabled{% endif %}></th>
                  <th style="width: 3%">#</th>
                  {% for header in headers %}
                  <th {% if header == quantity_delivered_key %}class="quantity-delivered-header"{% endif %}>
                    {{ header }}
                  </th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for item in raw_data %}
                <tr data-row-index="{{ item|get_item:'_business_id' }}" 
                    data-quantity-delivered="{{ item|get_item:quantity_delivered_key|default:'0' }}" 
                    data-ordered-quantity="{{ item|get_item:ordered_quantity_key|default:'0' }}" 
                    class="data-row">
                  <td><input type="checkbox" class="row-checkbox" data-row="{{ item|get_item:'_business_id' }}" {% if is_migration_ifs %}disabled{% endif %}></td>
                  <td>{{ item|get_item:'_business_id' }}</td>
                  {% for header in headers %}
                  <td class="{% if header == 'Content' or header == 'description' %}field-longtext{% endif %} {% if header == quantity_delivered_key %}quantity-delivered-cell{% endif %}" 
                      {% if header == quantity_delivered_key %}data-row="{{ item|get_item:'_business_id' }}" 
                      data-original="{{ item|get_item:quantity_delivered_key|default:'0' }}" 
                      data-original-value="{{ item|get_item:quantity_delivered_key|default:'0' }}" 
                      data-ordered="{{ item|get_item:ordered_quantity_key|default:'0' }}" {% endif %}
                      data-column="{{ header }}">
                    
                    {% if header == ordered_quantity_key %}
                    <span class="ordered-quantity" data-row="{{ item|get_item:'_business_id' }}" style="display: block; text-align: right;">
                      {{ item|get_item:ordered_quantity_key|floatformat:"0" }}
                    </span>
                    {% elif header == quantity_delivered_key %}
                    <input type="text" class="quantity-delivered-input" value="{{ item|get_item:quantity_delivered_key|default:'0'|floatformat:'0' }}" 
                           data-row="{{ item|get_item:'_business_id' }}" 
                           data-original="{{ item|get_item:quantity_delivered_key|default:'0' }}"
                           data-original-value="{{ item|get_item:quantity_delivered_key|default:'0' }}"
                           {% if is_migration_ifs %}disabled readonly style="background-color: #e9ecef; cursor: not-allowed;"{% endif %} 
                           data-ordered="{{ item|get_item:ordered_quantity_key|default:'0' }}"
                           style="border: none; background: transparent; width: 100%; padding: 0; margin: 0; outline: none; text-align: right;">
                    {% elif header == quantity_not_delivered_key %}
                    <span class="quantity-not-delivered" data-row="{{ item|get_item:'_business_id' }}" style="display: block; text-align: right;">
                      {{ item|get_item:quantity_not_delivered_key|default:"0"|floatformat:"0" }}
                    </span>
                    {% elif header == 'Amount Delivered' or header == 'Amount Not Delivered' or header == 'Quantity Payable' %}
                    <span class="{% if header == 'Amount Delivered' %}amount-delivered{% elif header == 'Amount Not Delivered' %}amount-not-delivered{% else %}quantity-payable{% endif %}" 
                           data-row="{{ item|get_item:'_business_id' }}" style="display: block; text-align: right;">
                      {{ item|get_item:header|default:"0"|floatformat:"2" }}
                    </span>
                    {% elif header == 'Amount Payable' %}
                    <span class="amount-payable" 
                           data-row="{{ item|get_item:'_business_id' }}" style="display: block; text-align: right;">
                      {{ item|get_item:header|default:"0"|floatformat:"2" }}
                    </span>
                    {% else %}
                    {{ item|get_item:header }}
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                {% empty %}
                <tr><td colspan="{{ headers|length|add:2 }}">Aucune donnée disponible</td></tr>
                {% endfor %}
              </tbody>
              {% if montant_total > 0 %}
              <tfoot>
                <tr>
                  <td colspan="{{ headers|length|add:1 }}" class="text-end">PO AMOUNT:</td>
                  <td class="text-end"><strong>{{ montant_total|floatformat|intcomma }} {{ devise }}</strong></td>
                  <td></td>  <!-- Add empty cell for new column -->
                </tr>
              </tfoot>
              {% endif %}
            </table>
          </div>
        </div>
      </div>
    </div>

  </section>

  <!-- 4. PANEL LATÉRAL : SÉLECTEUR DE COLONNES -->
  <aside id="columnSelectorSidebar" class="position-fixed top-0 end-0 bg-white shadow-lg" style="width: 350px; height: 100vh; z-index: 1050; transform: translateX(100%); transition: transform 0.3s ease; overflow-y: auto; padding: 20px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 class="mb-0">Select Columns to Display</h5>
      <button type="button" class="btn-close" id="closeColumnSelector" aria-label="Close"></button>
    </div>
    
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <button id="selectAllColumns" class="btn btn-sm btn-outline-primary">Select All</button>
        <button id="deselectAllColumns" class="btn btn-sm btn-outline-secondary">Deselect All</button>
        <button id="resetColumnSelection" class="btn btn-sm btn-outline-danger">Reset</button>
      </div>
    </div>
    
    <div style="max-height: calc(100vh - 200px); overflow-y: auto;">
      {% for header in headers %}
      <div class="form-check mb-2">
        <input class="form-check-input column-checkbox" type="checkbox" value="{{ header }}" id="col_{{ forloop.counter }}" checked>
        <label class="form-check-label" for="col_{{ forloop.counter }}">
          {{ header }}
        </label>
      </div>
      {% endfor %}
    </div>
    
    <div class="mt-4 d-grid">
      <button type="button" class="btn btn-primary" id="applyColumnSelection">Apply</button>
    </div>
  </aside>

  <!-- 5. OVERLAY -->
  <div id="sidebarOverlay" class="position-fixed top-0 start-0" style="width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.5); z-index: 1040; display: none;"></div>

  <!-- Modal personnalisé pour la rétention -->
  <div id="retentionModalCustom" class="retention-modal hidden" aria-hidden="true" role="dialog" aria-labelledby="retentionModalTitle">
    <div id="retentionModalOverlay" class="retention-modal__overlay"></div>
    <div class="retention-modal__dialog" role="document">
      <div class="retention-modal__header">
        <h5 id="retentionModalTitle" class="retention-modal__title">Define Retention on Payment </h5>
        <button type="button" id="retentionModalClose" class="retention-modal__close" aria-label="Close">&times;</button>
      </div>
      <div class="retention-modal__body">
        <form id="retentionForm" onsubmit="return false;">
          <div class="mb-3">
            <label for="retentionRate" class="form-label">Payment Retention rate (%)</label>
            <input type="number" class="form-control" id="retentionRate" min="0" max="10" step="0.01" value="{{ retention_rate|default:0 }}">
          </div>
          <div class="mb-3">
            <label for="retentionCause" class="form-label">Cause of the retention</label>
            <textarea class="form-control" id="retentionCause" rows="3">{{ retention_cause|default:'' }}</textarea>
          </div>
        </form>
      </div>
      <div class="retention-modal__footer">
        <button type="button" class="btn btn-secondary" id="retentionModalCancel">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveRetentionBtn">Save</button>
      </div>
    </div>
  </div>

  <style>
    /* Styles minimaux pour le modal personnalisé */
    .retention-modal.hidden { display: none; }
    .retention-modal { position: fixed; inset: 0; z-index: 1100; }
    .retention-modal__overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
    .retention-modal__dialog { position: relative; width: 100%; max-width: 520px; margin: 10vh auto; background: #fff; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
    .retention-modal__header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #eee; }
    .retention-modal__title { margin: 0; font-size: 1.1rem; }
    .retention-modal__close { background: transparent; border: none; font-size: 1.5rem; line-height: 1; cursor: pointer; }
    .retention-modal__body { padding: 16px; }
    .retention-modal__footer { display: flex; justify-content: flex-end; gap: 8px; padding: 12px 16px; border-top: 1px solid #eee; }
    
    /* Styles pour le mode correction -->
    .correction-selection-mode {
        background-color: rgba(253, 126, 20, 0.05);
    }
    
    .correction-selection-mode .row-checkbox:checked {
        accent-color: #fd7e14;
    }
    
    /* Styles pour le modal de correction -->
    .correction-modal-content {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .line-correction-section {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background-color: #f8f9fa;
    }
    
    .line-title {
        color: #495057;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 8px;
        margin-bottom: 12px;
    }
    
    .history-entries .table {
        margin-bottom: 0;
        font-size: 0.9rem;
    }
    
    .custom-correction-section {
        background-color: #fff;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }
    
    /* Animation pour le bouton de validation de correction -->
    #validate-correction-selection button {
        animation: pulse-correction 2s infinite;
    }
    
    @keyframes pulse-correction {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    /* Animation pour les boutons collectifs -->
    .pulse-animation {
        animation: pulse-collective 0.5s ease-in-out;
    }
    
    @keyframes pulse-collective {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
  </style>
</main>
{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 pour des alertes et confirmations élégantes -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Variables pour le JavaScript -->
<script>
    // Variables pour l'API
    const bonId = "{{ bon.id }}";
    const fichierId = "{{ bon.id }}";
    const bonNumber = "{{ bon_number }}";
    const orderedKey = "{{ ordered_quantity_key }}";
    const bonCommandeId = "{{ bon_commande_id }}";
    const poAmount = "{{ montant_total|floatformat:0 }}";
    const amountDelivered = "{{ montant_total_recu|floatformat:0 }}";
    const deliveryRate = "{{ taux_avancement|floatformat:2 }}";
    const currency = "{{ devise }}";
    const supplier = "{{ supplier|default:'N/A' }}";
    const retentionRate = "{{ retention_rate|default:'0' }}";
    const retentionCause = "{{ retention_cause|default:'N/A' }}";
</script>

<script src="{% static 'orders/js/detail_bon.js' %}"></script>
{% endblock %}