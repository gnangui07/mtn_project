{% extends 'base.html' %}
{% load static %}
{% load orders_extras %}
{% load humanize %}
{% load i18n %}
{% block title %}Purchase Order Details: {{ bon_number }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'orders/css/detail_bon.css' %}">
<link rel="stylesheet" href="{% static 'orders/css/detail_bon_spectrum.css' %}">
{% endblock %}

{% block content %}
<div class="spectrum-page-container">
    <!-- Header Principal -->
    <header class="spectrum-page-header">
        <div class="page-header-content">
            <div class="header-main">
                <div class="spectrum-breadcrumb">
                    <a href="{% url 'orders:reception' %}" class="text-decoration-none text-white opacity-75">
                        <i class="fas fa-arrow-left me-2"></i> Reception Register
                    </a>
                    <span class="breadcrumb-divider">/</span>
                    <span>Purchase Order Details</span>
                </div>
                
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-file-invoice me-3"></i>
                            {{ bon_number }}
                        </h1>
                        
                        <div class="header-subtitle">
                            <div class="supplier-info">{{ supplier }}</div>
                            <div class="coordinator-info">{{ project_coordinator|default:'N/A' }}</div>
                        </div>
                    </div>
                    
                    <div class="header-action-buttons">
                        <a href="{% url 'orders:reception' %}" class="spectrum-button spectrum-button-secondary">
                            <i class="fas fa-arrow-left me-2"></i> Back
                        </a>
                        
                        <div class="dropdown">
                            <button class="dropdown-actions" type="button" id="moreActionsDropdown" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-h me-2"></i> Actions
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="moreActionsDropdown">
                                {% if bon_commande_id %}
                                <li>
                                    <button class="dropdown-item" type="button" id="download-document"
                                            data-bon-id="{{ bon_commande_id|default_if_none:'' }}"
                                            data-bon-number="{{ selected_order.numero|default_if_none:'' }}">
                                        <i class="fas fa-file-download me-2"></i> Generate Document
                                    </button>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'orders:timeline_delays' bon_commande_id=bon_commande_id %}?fichier_id={{ bon_id }}"
                                       {% if is_migration_ifs %}aria-disabled="true" onclick="return false;"{% endif %}>
                                        <i class="fas fa-clock me-2"></i> Timeline Delays
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'orders:vendor_evaluation' bon_commande_id=bon_commande_id %}?fichier_id={{ bon_id }}"
                                       {% if is_migration_ifs %}aria-disabled="true" onclick="return false;"{% endif %}>
                                        <i class="fas fa-star me-2"></i> Vendor Evaluation
                                    </a>
                                </li>
                                {% endif %}
                                <li>
                                    <a class="dropdown-item" href="{% url 'orders:export_bon_excel' bon_id=bon_id %}{% if selected_order_number %}?selected_order_number={{ selected_order_number }}{% endif %}"
                                       {% if is_migration_ifs %}aria-disabled="true" onclick="return false;"{% endif %}>
                                        <i class="fas fa-file-excel me-2"></i> Export Delivery Report
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <button class="dropdown-item" id="set-retention-btn" type="button"
                                            data-retention-rate="{{ retention_rate|default:0 }}"
                                            data-retention-cause="{{ retention_cause|default:'' }}"
                                            {% if is_migration_ifs %}disabled{% endif %}>
                                        <i class="fas fa-exclamation-triangle me-2"></i> Define Retention
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Métriques principales -->
                <div class="spectrum-metric-grid">
                    <div class="spectrum-metric">
                        <div class="metric-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value">{{ montant_total|floatformat|intcomma }} {{ devise }}</div>
                            <div class="metric-label">PO Amount</div>
                        </div>
                    </div>
                    <div class="spectrum-metric">
                        <div class="metric-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value montant-total-recue">{{ montant_total_recu|floatformat:0|intcomma }} {{ devise }}</div>
                            <div class="metric-label">Amount Delivered</div>
                        </div>
                    </div>
                    <div class="spectrum-metric">
                        <div class="metric-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value taux-avancement">{{ taux_avancement|floatformat:2 }}%</div>
                            <div class="metric-label">Delivery Rate</div>
                        </div>
                    </div>
                    <div class="spectrum-metric">
                        <div class="metric-icon">
                            <i class="fas fa-percent"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value">{{ retention_rate|default:'0' }}%</div>
                            <div class="metric-label">Retention Rate</div>
                        </div>
                    </div>
                </div>
                
                {% if is_migration_ifs %}
                <div class="alert-banner">
                    <i class="fas fa-lock"></i>
                    <div>
                        <strong>Read-Only Mode:</strong> This purchase order contains "Migration IFS" items. All actions are disabled.
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- Onglets -->
    <nav class="spectrum-tabs">
        <button class="spectrum-tab active" data-target="#details">
            <i class="fas fa-info-circle me-2"></i> PO Header
        </button>
        <button class="spectrum-tab" data-target="#rawdata">
            <i class="fas fa-table me-2"></i> PO Lines Delivery Status
        </button>
    </nav>

    <!-- Contenu des onglets -->
    <main class="tab-content">
        <!-- Onglet Détails -->
        <section id="details" class="tab-pane active">
            <div class="info-grid">
                <div class="spectrum-info-card">
                    <div class="info-card-header">
                        <div class="info-card-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <h3 class="info-card-title">Purchase Order Information</h3>
                    </div>
                    <div class="info-item-grid">
                        <div class="info-label">Order Description</div>
                        <div class="info-value">{{ order_description|default:'N/A' }}</div>
                        
                        <div class="info-label">Project Name</div>
                        <div class="info-value">{{ project_name|default:'N/A' }}</div>
                        
                        <div class="info-label">Order Status</div>
                        <div class="info-value">{{ order_status|default:'N/A' }}</div>
                        
                        <div class="info-label">Creation Date</div>
                        <div class="info-value">
                            {% language 'en' %}
                            {{ date_creation|date:"F d, Y H:i" }}
                            {% endlanguage %}
                        </div>
                        
                        <div class="info-label">Number of Lines</div>
                        <div class="info-value">{{ nb_lignes }}</div>
                        
                        <div class="info-label">PIP End Date</div>
                        <div class="info-value">{{ pip_end_date|default:'N/A' }}</div>
                        
                        <div class="info-label">Actual End Date</div>
                        <div class="info-value">{{ actual_end_date|default:'N/A' }}</div>
                    </div>
                </div>
                
                <div class="spectrum-info-card">
                    <div class="info-card-header">
                        <div class="info-card-icon">
                            <i class="fas fa-file-import"></i>
                        </div>
                        <h3 class="info-card-title">Source File Details</h3>
                    </div>
                    <div class="info-item-grid">
                        <div class="info-label">File ID</div>
                        <div class="info-value">{{ bon.id }}</div>
                        
                        <div class="info-label">File Name</div>
                        <div class="info-value">{{ bon.fichier.name|default:'N/A' }}</div>
                        
                        <div class="info-label">File Type</div>
                        <div class="info-value">
                            <span class="metric-chip chip-yellow">{{ extension|upper }}</span>
                        </div>
                        
                        <div class="info-label">Import Date</div>
                        <div class="info-value">
                            {% language 'en' %}
                            {{ bon.date_importation|date:"F d, Y H:i" }}
                            {% endlanguage %}
                        </div>
                        
                        <div class="info-label">Imported By</div>
                        <div class="info-value">{{ imported_by|default:'System' }}</div>
                        
                        <div class="info-label">File Size</div>
                        <div class="info-value">{% if file_exists and file_size %}{{ file_size|filesizeformat }}{% else %}N/A{% endif %}</div>
                    </div>
                </div>
                
                {% if messages %}
                <div class="spectrum-info-card">
                    <div class="info-card-header">
                        <div class="info-card-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <h3 class="info-card-title">Notifications</h3>
                    </div>
                    <div class="info-card-body">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} mb-2">
                            {{ message }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- Onglet Données Brutes -->
        <section id="rawdata" class="tab-pane">
            <!-- Filtres -->
            <div class="filter-bar">
                <div class="filter-header">
                    <div>
                        <h4 class="mb-0">PO Lines Analysis</h4>
                        <small class="text-muted">Filtered view for purchase order {{ bon_number }}</small>
                    </div>
                    <div class="filter-buttons">
                        <button class="spectrum-filter-btn active" data-filter="all">
                            All Lines <span class="filter-badge" id="count-all">{{ nb_lignes }}</span>
                        </button>
                        <button class="spectrum-filter-btn" data-filter="partially-delivered">
                            <i class="fas fa-truck-loading me-1"></i> Partial <span class="filter-badge" id="count-partial">0</span>
                        </button>
                        <button class="spectrum-filter-btn" data-filter="fully-delivered">
                            <i class="fas fa-check-double me-1"></i> Complete <span class="filter-badge" id="count-full">0</span>
                        </button>
                        <button type="button" class="spectrum-button spectrum-button-gray" id="toggleColumnSelector">
                            <i class="fas fa-columns me-1"></i> Columns
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tableau -->
            <div class="spectrum-table-container">
                <div class="table-header">
                    <div class="table-title">
                        <h5>
                            <i class="fas fa-table me-2"></i>
                            Delivery Lines
                        </h5>
                        <span class="table-subtitle">{{ nb_lignes }} items</span>
                    </div>
                    
                    {% if not is_migration_ifs %}
                    <div id="collective-quantity-delivered-container" style="display: none;">
                        <button id="apply-collective-quantity-delivered" class="spectrum-button spectrum-button-accent">
                            <i class="fas fa-check-circle me-2"></i> Apply to Selected 
                            <span id="selected-count-badge" class="metric-chip chip-white ms-2">0</span>
                        </button>
                    </div>
                    {% endif %}
                </div>
                
                <!-- DATA CONTAINER PRÉSERVÉ -->
                <div class="data-container">
                    <table class="data-table" id="result_list">
                        <thead>
                            <tr>
                                <th style="width: 3%"><input type="checkbox" id="select-all-rows" {% if is_migration_ifs %}disabled{% endif %}></th>
                                <th style="width: 3%">#</th>
                                {% for header in headers %}
                                <th {% if header == quantity_delivered_key %}class="quantity-delivered-header"{% endif %}>
                                    {{ header }}
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in raw_data %}
                            <tr data-row-index="{{ item|get_item:'_business_id' }}" 
                                data-quantity-delivered="{{ item|get_item:quantity_delivered_key|default:'0' }}" 
                                data-ordered-quantity="{{ item|get_item:ordered_quantity_key|default:'0' }}" 
                                class="data-row">
                                <td><input type="checkbox" class="row-checkbox" data-row="{{ item|get_item:'_business_id' }}" {% if is_migration_ifs %}disabled{% endif %}></td>
                                <td>{{ item|get_item:'_business_id' }}</td>
                                {% for header in headers %}
                                <td class="{% if header == 'Content' or header == 'description' %}field-longtext{% endif %} {% if header == quantity_delivered_key %}quantity-delivered-cell{% endif %}" 
                                    {% if header == quantity_delivered_key %}data-row="{{ item|get_item:'_business_id' }}" 
                                    data-original="{{ item|get_item:quantity_delivered_key|default:'0' }}" 
                                    data-original-value="{{ item|get_item:quantity_delivered_key|default:'0' }}" 
                                    data-ordered="{{ item|get_item:ordered_quantity_key|default:'0' }}" {% endif %}
                                    data-column="{{ header }}">
                                
                                    {% if header == ordered_quantity_key %}
                                    <span class="ordered-quantity" data-row="{{ item|get_item:'_business_id' }}" style="display: block; text-align: right;">
                                        {{ item|get_item:ordered_quantity_key|floatformat:"0" }}
                                    </span>
                                    {% elif header == quantity_delivered_key %}
                                    <input type="text" class="quantity-delivered-input" value="{{ item|get_item:quantity_delivered_key|default:'0'|floatformat:'0' }}" 
                                           data-row="{{ item|get_item:'_business_id' }}" 
                                           data-original="{{ item|get_item:quantity_delivered_key|default:'0' }}"
                                           data-original-value="{{ item|get_item:quantity_delivered_key|default:'0' }}"
                                           {% if is_migration_ifs %}disabled readonly style="background-color: #e9ecef; cursor: not-allowed;"{% endif %} 
                                           data-ordered="{{ item|get_item:ordered_quantity_key|default:'0' }}"
                                           style="border: none; background: transparent; width: 100%; padding: 0; margin: 0; outline: none; text-align: right;">
                                    {% elif header == quantity_not_delivered_key %}
                                    <span class="quantity-not-delivered" data-row="{{ item|get_item:'_business_id' }}" style="display: block; text-align: right;">
                                        {{ item|get_item:quantity_not_delivered_key|default:"0"|floatformat:"0" }}
                                    </span>
                                    {% elif header == 'Amount Delivered' or header == 'Amount Not Delivered' or header == 'Quantity Payable' %}
                                    <span class="{% if header == 'Amount Delivered' %}amount-delivered{% elif header == 'Amount Not Delivered' %}amount-not-delivered{% else %}quantity-payable{% endif %}" 
                                           data-row="{{ item|get_item:'_business_id' }}" style="display: block; text-align: right;">
                                        {{ item|get_item:header|default:"0"|floatformat:"2" }}
                                    </span>
                                    {% elif header == 'Amount Payable' %}
                                    <span class="amount-payable" 
                                           data-row="{{ item|get_item:'_business_id' }}" style="display: block; text-align: right;">
                                        {{ item|get_item:header|default:"0"|floatformat:"2" }}
                                    </span>
                                    {% else %}
                                    {{ item|get_item:header }}
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% empty %}
                            <tr><td colspan="{{ headers|length|add:2 }}">No data available</td></tr>
                            {% endfor %}
                        </tbody>
                        {% if montant_total > 0 %}
                        <tfoot>
                            <tr>
                                <td colspan="{{ headers|length|add:1 }}" class="text-end">PO AMOUNT:</td>
                                <td class="text-end"><strong>{{ montant_total|floatformat|intcomma }} {{ devise }}</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                        {% endif %}
                    </table>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Modal de rétention -->
<div id="retentionModalCustom" class="retention-modal hidden" aria-hidden="true" role="dialog" aria-labelledby="retentionModalTitle">
    <div id="retentionModalOverlay" class="retention-modal__overlay"></div>
    <div class="retention-modal__dialog" role="document">
        <div class="retention-modal__header">
            <h5 id="retentionModalTitle" class="retention-modal__title">Define Retention on Payment</h5>
            <button type="button" id="retentionModalClose" class="retention-modal__close" aria-label="Close">&times;</button>
        </div>
        <div class="retention-modal__body">
            <form id="retentionForm" onsubmit="return false;">
                <div class="mb-3">
                    <label for="retentionRate" class="form-label">Payment Retention rate (%)</label>
                    <input type="number" class="form-control" id="retentionRate" min="0" max="10" step="0.01" value="{{ retention_rate|default:0 }}">
                </div>
                <div class="mb-3">
                    <label for="retentionCause" class="form-label">Cause of the retention</label>
                    <textarea class="form-control" id="retentionCause" rows="3">{{ retention_cause|default:'' }}</textarea>
                </div>
            </form>
        </div>
        <div class="retention-modal__footer">
            <button type="button" class="btn btn-secondary" id="retentionModalCancel">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveRetentionBtn">Save</button>
        </div>
    </div>
</div>

<!-- Panel latéral pour sélection des colonnes -->
<aside id="columnSelectorSidebar" class="position-fixed top-0 end-0 bg-white shadow-lg" style="width: 350px; height: 100vh; z-index: 1050; transform: translateX(100%); transition: transform 0.3s ease; overflow-y: auto; padding: 20px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">Select Columns to Display</h5>
        <button type="button" class="btn-close" id="closeColumnSelector" aria-label="Close"></button>
    </div>
    
    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <button id="selectAllColumns" class="btn btn-sm btn-outline-primary">Select All</button>
            <button id="deselectAllColumns" class="btn btn-sm btn-outline-secondary">Deselect All</button>
            <button id="resetColumnSelection" class="btn btn-sm btn-outline-danger">Reset</button>
        </div>
    </div>
    
    <div style="max-height: calc(100vh - 200px); overflow-y: auto;">
        {% for header in headers %}
        <div class="form-check mb-2">
            <input class="form-check-input column-checkbox" type="checkbox" value="{{ header }}" id="col_{{ forloop.counter }}" checked>
            <label class="form-check-label" for="col_{{ forloop.counter }}">
                {{ header }}
            </label>
        </div>
        {% endfor %}
    </div>
    
    <div class="mt-4 d-grid">
        <button type="button" class="btn btn-primary" id="applyColumnSelection">Apply</button>
    </div>
</aside>

<!-- Overlay pour le panel latéral -->
<div id="sidebarOverlay" class="position-fixed top-0 start-0" style="width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.5); z-index: 1040; display: none;"></div>

<script>
    // Gestion des onglets
    document.addEventListener('DOMContentLoaded', function() {
        const tabs = document.querySelectorAll('.spectrum-tab');
        const tabPanes = document.querySelectorAll('.tab-pane');
        
        // Afficher le premier onglet par défaut
        document.querySelector('.spectrum-tab.active').click();
        
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                
                // Désactiver tous les onglets
                tabs.forEach(t => t.classList.remove('active'));
                tabPanes.forEach(p => {
                    p.classList.remove('active');
                    p.style.display = 'none';
                });
                
                // Activer l'onglet sélectionné
                this.classList.add('active');
                const targetPane = document.querySelector(targetId);
                targetPane.classList.add('active');
                targetPane.style.display = 'block';
            });
        });
    });
</script>
{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 pour des alertes et confirmations élégantes -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Variables pour le JavaScript -->
<script>
    const bonId = "{{ bon.id }}";
    const fichierId = "{{ bon.id }}";
    const bonNumber = "{{ bon_number }}";
    const orderedKey = "{{ ordered_quantity_key }}";
    const bonCommandeId = "{{ bon_commande_id }}";
    const poAmount = "{{ montant_total|floatformat:0 }}";
    const amountDelivered = "{{ montant_total_recu|floatformat:0 }}";
    const deliveryRate = "{{ taux_avancement|floatformat:2 }}";
    const currency = "{{ devise }}";
    const supplier = "{{ supplier|default:'N/A' }}";
    const retentionRate = "{{ retention_rate|default:'0' }}";
    const retentionCause = "{{ retention_cause|default:'N/A' }}";
</script>

<script src="{% static 'orders/js/detail_bon.js' %}"></script>
{% endblock %}