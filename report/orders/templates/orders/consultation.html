{% extends 'base.html' %}
{% load static %}

{% block title %}Consultation des Bons de Commande - MTN{% endblock %}

{% block extra_css %}
<!-- Inclure Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@x.x.x/dist/select2-bootstrap4.min.css" rel="stylesheet" />

<!-- Inclure notre CSS personnalisé -->
<link href="{% static 'orders/css/consultation.css' %}" rel="stylesheet" />
<link href="{% static 'orders/css/analytics_dashboard.css' %}" rel="stylesheet" />
<link href="{% static 'orders/css/custom_modal.css' %}" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Tableau de bord analytique -->
    <div id="analytics-dashboard" class="analytics-dashboard">
        <h2 class="dashboard-title mb-4">Tableau de bord analytique</h2>
        
        <!-- Contrôles de filtrage -->
        <div class="filter-controls mb-4">
            <div class="btn-group btn-group-toggle w-100" role="group" data-toggle="buttons">
                <button type="button" class="period-btn btn btn-outline-primary" data-period="7">
                    <i class="fas fa-calendar-week me-2"></i>7 jours
                </button>
                <button type="button" class="period-btn btn btn-outline-primary active" data-period="30">
                    <i class="far fa-calendar-alt me-2"></i>30 jours
                </button>
                <button type="button" class="period-btn btn btn-outline-primary" data-period="90">
                    <i class="fas fa-calendar-day me-2"></i>90 jours
                </button>
                <button type="button" class="period-btn btn btn-outline-primary" data-period="365">
                    <i class="fas fa-calendar me-2"></i>1 an
                </button>
            </div>
        </div>
        
        <!-- Indicateur de chargement -->
        <div id="analytics-loading" class="loading-spinner">
            <div class="spinner-border text-mtn-yellow" role="status">
                <span class="sr-only">Chargement...</span>
            </div>
        </div>
        
        <!-- Message d'erreur -->
        <div id="analytics-error" class="alert alert-danger" style="display: none;"></div>
        
        <!-- Cartes de statistiques et graphique -->
        <div class="row g-4 mb-4 justify-content-center">
            <!-- Carte 1: Nombre de bons avec réception -->
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm hover-zoom">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-shape icon-lg bg-soft-yellow text-yellow rounded-3 me-3">
                                <i class="fas fa-file-invoice fs-4"></i>
                            </div>
                            <h3 class="mb-0 fs-5 fw-semibold text-uppercase">Bons avec réception</h3>
                        </div>
                        <div class="d-flex align-items-baseline">
                            <h2 class="mb-0 fw-bold" id="bons-avec-reception">0</h2>
                            <span class="ms-2 text-muted small">bons</span>
                        </div>
                        <p class="text-muted small mt-2 mb-0">
                            Bons de commande ayant au moins une réception
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Carte 2: Total des bons de commande -->
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm hover-zoom">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-shape icon-lg bg-soft-yellow text-yellow rounded-3 me-3">
                                <i class="fas fa-clipboard-list fs-4"></i>
                            </div>
                            <h3 class="mb-0 fs-5 fw-semibold text-uppercase">Total des bons</h3>
                        </div>
                        <div class="d-flex align-items-baseline">
                            <h2 class="mb-0 fw-bold" id="total-bons">0</h2>
                            <span class="ms-2 text-muted small">enregistrés</span>
                        </div>
                        <p class="text-muted small mt-2 mb-0">
                            Tous les bons de commande dans le système
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Graphique: Diagramme circulaire -->
            <div class="col-12 col-lg-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="fas fa-chart-pie text-yellow me-2"></i>
                            Répartition des bons de commande
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="pie-chart"></canvas>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-0 py-2">
                        <small class="text-muted">Répartition des bons selon leur statut de réception</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Séparateur simple -->
    <div class="section-divider">
        <hr class="divider-line">
    </div>
    
    <h4 class="page-header mt-5"><i class="fas fa-search mr-2"></i> Delivery Report </h4>
    
    <!-- Filtre unique : liste déroulante des bons de commande -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="form-group">
                <label for="bon-select"><strong>Select a Purchase Order</strong></label>
                <select id="bon-select" class="form-control select2">
                    <option value="">All delivery orders</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Indicateur de chargement -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner-border text-mtn-yellow" role="status">
            <span class="sr-only">Chargement...</span>
        </div>
    </div>
    
    <!-- Message si aucun résultat -->
    <div id="no-results" class="alert alert-mtn" style="display: none;">
        <i class="fas fa-info-circle mr-2"></i> No results found.
    </div>
    
    <!-- Tableau des résultats -->
    <div class="table-responsive mt-3">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Reception Number</th>
                    <th>User</th>
                    <th>Date</th>
                    <th>Hour</th>
                    <th>Delivery Rate </th>
                </tr>
            </thead>
            <tbody id="activity-logs-body">
                <!-- Les données seront insérées ici par JavaScript -->
            </tbody>
        </table>
    </div>
    
    <!-- Modal personnalisé amélioré -->
    <div class="custom-modal" id="detailModal">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-container">
            <div class="custom-modal-content">
                <div class="custom-modal-header">
                    <h5 class="custom-modal-title">Delivery details</h5>
                    <button type="button" class="custom-modal-close" id="closeDetailModal">&times;</button>
                </div>
                <div class="custom-modal-body">
                    <ul class="nav nav-tabs" id="detailTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">Summary</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">Details</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">History</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-4">
                        <div class="tab-pane fade show active" id="summary" role="tabpanel">
                            <div class="detail-grid">
                                <div class="detail-card">
                                    <h6>Order Information</h6>
                                    <div class="detail-item">
                                        <span class="detail-label">Ordered Quantity :</span>
                                        <span class="detail-value" id="modal-total-amount"></span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Quantity Delivered :</span>
                                        <span class="detail-value" id="modal-amount-received"></span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">PO Amount :</span>
                                        <span class="detail-value" id="modal-po-amount"></span> <span id="modal-currency"></span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Line :</span>
                                        <span class="detail-value" id="modal-line"></span>
                                    </div>
                                </div>
                                
                                <div class="detail-card">
                                    <h6>Delivery Status</h6>
                                    <div class="detail-item">
                                        <span class="detail-label">Amount Delivered :</span>
                                        <span class="detail-value" id="modal-received-amount"></span> <span id="modal-currency"></span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Delivery Rate :</span>
                                        <span class="detail-value" id="modal-progress-rate"></span>%
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-export-excel" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i> Export to Excel
                            </button>
                        </div>
                        
                        <div class="tab-pane fade" id="details" role="tabpanel">
                            <div class="mb-5">
                                <h5 class="section-title">Current Delivery</h5>
                                <div class="table-container">
                                    <table class="excel-table">
                                        <thead>
                                            <tr>
                                                <th>Reception Number</th>
                                                <th>Order Number</th>
                                                <th>Line Description</th>
                                                <th>Order Description</th>
                                                <th>Supplier</th>
                                                <th>Ordered</th>
                                                <th>Project Number</th>
                                                <th>Task Number</th>
                                                <th>Schedule</th>
                                                <th>Line</th>
                                                <th>Ordered Quantity</th>
                                                <th>Quantity Delivered</th>
                                                <th>Quantity Not Delivered</th>
                                                <th>Price</th>
                                            </tr>
                                        </thead>
                                        <tbody id="current-reception-tbody">
                                            <!-- Rempli dynamiquement -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="history" role="tabpanel">
                            <div>
                                <h5 class="section-title"> Delivery History </h5>
                                <div class="table-container">
                                    <table class="excel-table" id="reception-history-table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Order Number</th>
                                                <th>Line</th>
                                                <th>Ordered Quantity</th>
                                                <th>Quantity Delivered</th>
                                                <th>Cumulative Reception</th>
                                                <th>Quantity Not Delivered</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Rempli dynamiquement -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="custom-modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDetailModal()">close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Inclure Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Inclure Chart.js pour les graphiques -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<!-- Inclure XLSX pour l'export Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Variables pour les URLs Django -->
<script>
    // Définir les URLs pour les fichiers JS externes
    const getAllBonsUrl = '{% url "orders:get_all_bons" %}';
    const getActivityLogsUrl = '{% url "orders:get_activity_logs" %}';
    const getAnalyticsUrl = '{% url "orders:get_analytics_data" %}';
</script>

<!-- Inclure nos JS personnalisés -->
<script src="{% static 'orders/js/consultation.js' %}"></script>
<script src="{% static 'orders/js/analytics_dashboard.js' %}"></script>
<!-- heatmap.min.js supprimé (carte thermique retirée) -->
<script src="{% static 'orders/js/custom_modal.js' %}"></script>
{% endblock %}
