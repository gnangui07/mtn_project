{% extends 'base.html' %}
{% load static %}

{% block title %}Consultation des Bons de Commande - MTN{% endblock %}

{% block extra_css %}
<!-- Inclure Select2 CSS (Local) -->
<link href="{% static 'css/vendor/select2.min.css' %}" rel="stylesheet" />
<!-- Thème Bootstrap 5 pour Select2 (Local) -->
<link href="{% static 'css/vendor/select2-bootstrap-5-theme.min.css' %}" rel="stylesheet" />

<!-- Inclure notre CSS personnalisé -->
<link href="{% static 'orders/css/consultation.css' %}" rel="stylesheet" />
<link href="{% static 'orders/css/analytics_dashboard.css' %}" rel="stylesheet" />
<link href="{% static 'orders/css/custom_modal.css' %}" rel="stylesheet" />

<style>
:root {
    --soft-yellow: #FFE58F;
    --soft-yellow-bg: #FFF7D6;
    --soft-black: #000000;
    --soft-gray: #f6f7f9;
    --card-shadow: 0 6px 16px rgba(0,0,0,0.1);
    --modal-backdrop: rgba(0, 0, 0, 0.5);
    --modal-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    --modal-radius: 16px;
    --border-color: #e5e7eb;
    --primary-color: #3b82f6;
    --success-color: #10b981;
}

.container-fluid { padding-left: 1rem; padding-right: 1rem; }
.analytics-dashboard { background: var(--soft-gray); border: 1px solid #eee; border-radius: 12px; padding: 16px; }
.dashboard-title { color: var(--soft-black); letter-spacing: .3px; }
.filter-controls .btn-group { gap: 8px; }
.period-btn { border: 1px solid #ddd; background: #fff; color: var(--soft-black); border-radius: 8px; padding: 8px 12px; }
.period-btn.active { background: var(--soft-yellow-bg); border-color: var(--soft-yellow); color: var(--soft-black); }
.loading-spinner { display: none; justify-content: center; align-items: center; padding: 12px; }
.row.g-4 > [class*='col-'] .card { border-radius: 12px; box-shadow: var(--card-shadow); }
.chart-container { padding: 4px; }
.section-divider { margin-top: 24px; margin-bottom: 8px; }
.divider-line { border: 0; height: 1px; background: #eaeaea; }
.page-header { margin-top: 24px; margin-bottom: 16px; color: var(--soft-black); }
.table-responsive { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 12px; }
.spectrum-Table { width: 100%; }
.spectrum-Table thead { background: #222; }
.spectrum-Table-headCell { color: var(--soft-yellow) !important; background-color: #222 !important; }
.spectrum-Table-row:hover { background: rgba(255,229,143,0.2); }
.excel-table { width:100%; border-collapse: collapse; }
.excel-table th, .excel-table td { border-bottom: 1px solid #eee; padding: 10px; }
.excel-table thead th { background: #fafafa; color: var(--soft-black); }
#analytics-error { margin-top: 8px; }

/* Modal Modernisé */
.modern-modal {
    position: fixed;
    inset: 0;
    z-index: 1050;
    display: none;
}

.modern-modal.active {
    display: block;
}

.modern-modal-backdrop {
    position: fixed;
    inset: 0;
    background: var(--modal-backdrop);
    backdrop-filter: blur(4px);
    animation: fadeIn 0.2s ease;
}

.modern-modal-dialog {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    pointer-events: none;
}

.modern-modal-content {
    background: #fff;
    border-radius: var(--modal-radius);
    box-shadow: var(--modal-shadow);
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    pointer-events: auto;
    overflow: hidden;
    animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Modal Header */
.modern-modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 10;
}

.modern-modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--soft-black);
    margin: 0;
}

.modern-modal-subtitle {
    color: #6b7280;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.modal-header-main {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
}

.modal-header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

/* Tabs Navigation */
.modal-tabs {
    display: flex;
    gap: 2px;
    background: #f9fafb;
    border-radius: 8px;
    padding: 4px;
}

.tab-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: transparent;
    border: none;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}

.tab-btn:hover:not(.active) {
    background: #f3f4f6;
    color: var(--soft-black);
}

.tab-btn.active {
    background: white;
    color: var(--primary-color);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    font-weight: 600;
}

.tab-btn svg {
    width: 18px;
    height: 18px;
}

/* Modal Body */
.modern-modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    min-height: 0;
}

.tab-panel {
    outline: none;
}

.tab-panel:focus-visible {
    box-shadow: inset 0 0 0 2px var(--primary-color);
    border-radius: 4px;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

/* Tables */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--soft-black);
    margin: 0;
}

.section-actions {
    display: flex;
    gap: 0.5rem;
}

.table-wrapper {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}

.table-scroll {
    overflow-x: auto;
    max-height: 50vh;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

.data-table thead {
    background: #f9fafb;
    position: sticky;
    top: 0;
    z-index: 1;
}

.data-table th {
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--soft-black);
    border-bottom: 1px solid var(--border-color);
    white-space: nowrap;
}

.data-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--soft-black);
}

.data-table tbody tr:hover {
    background: #f9fafb;
}

/* Modal Footer */
.modern-modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    background: #fff;
    position: sticky;
    bottom: 0;
    z-index: 10;
}

/* Buttons */
.btn {
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}

.btn-secondary {
    background: #f3f4f6;
    color: var(--soft-black);
}

.btn-secondary:hover {
    background: #e5e7eb;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--soft-black);
}

.btn-outline:hover {
    background: #f9fafb;
}

.btn-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
}

.btn-icon {
    background: none;
    border: none;
    padding: 0.5rem;
    color: #6b7280;
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-icon:hover {
    background: #f3f4f6;
    color: var(--soft-black);
}

.btn-close {
    background: none;
    border: none;
    padding: 0.5rem;
    color: #6b7280;
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-close:hover {
    background: #f3f4f6;
    color: #ef4444;
}

/* Table containers */
.table-container {
    border: 1px solid #eee;
    border-radius: 12px;
    padding: 8px;
    background: #fff;
    max-height: 50vh;
    overflow-y: auto;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.details-table-container {
    max-height: 45vh;
}

.details-table {
    table-layout: auto;
    width: 100%;
    min-width: 800px;
}

.details-table th,
.details-table td {
    white-space: nowrap;
    padding: 8px;
    font-size: 0.92rem;
}

.details-table thead th {
    position: sticky;
    top: 0;
    z-index: 2;
}

.details-table td:nth-child(3),
.details-table td:nth-child(4) {
    white-space: normal;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* ============================================
   RESPONSIVE - Support tous écrans
   ============================================ */

/* Petits laptops (1024px - 1366px) */
@media (max-width: 1366px) {
    .container-fluid {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
    }
    
    .analytics-dashboard {
        padding: 12px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
    }
    
    .modern-modal-content {
        max-width: 95%;
    }
    
    .details-table {
        min-width: 700px;
    }
    
    .table-container {
        max-height: 45vh;
    }
    
    .btn-group .period-btn {
        padding: 6px 10px;
        font-size: 0.85rem;
    }
    
    .row.g-4 > [class*='col-xl-3'] {
        flex: 0 0 50%;
        max-width: 50%;
    }
}

/* Tablettes (max 1024px) */
@media (max-width: 1024px) {
    .analytics-dashboard {
        padding: 10px;
    }
    
    .dashboard-title {
        font-size: 1.25rem !important;
    }
    
    .btn-group {
        flex-wrap: wrap;
    }
    
    .btn-group .period-btn {
        flex: 1 1 45%;
        margin-bottom: 0.5rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }
    
    .modern-modal-content {
        max-width: 98%;
    }
    
    .details-table {
        min-width: 600px;
    }
    
    .table-container {
        max-height: 40vh;
    }
    
    .row.g-4 > [class*='col-'] {
        flex: 0 0 50%;
        max-width: 50%;
    }
    
    .heatmap-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .heatmap-data-type {
        width: 100%;
    }
    
    #heatmap-chart {
        height: 280px;
    }
}

/* Mobiles (max 768px) */
@media (max-width: 768px) {
    .modern-modal-dialog {
        padding: 0;
        align-items: flex-end;
    }
    
    .modern-modal-content {
        max-height: 90vh;
        border-radius: 16px 16px 0 0;
        animation: slideUp 0.3s ease;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-tabs {
        overflow-x: auto;
        padding: 4px;
    }
    
    .tab-btn {
        min-width: 100px;
        font-size: 0.75rem;
        padding: 0.5rem;
    }
    
    .modal-header-main {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .modal-header-actions {
        justify-content: space-between;
    }
    
    .container-fluid {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
    }
    
    .analytics-dashboard {
        padding: 8px;
        border-radius: 8px;
    }
    
    .dashboard-title {
        font-size: 1.1rem !important;
    }
    
    .btn-group .period-btn {
        flex: 1 1 100%;
        padding: 8px;
        font-size: 0.8rem;
    }
    
    .details-table {
        min-width: 600px;
        font-size: 0.75rem;
    }
    
    .details-table th,
    .details-table td {
        padding: 6px !important;
    }
    
    .table-container {
        max-height: 35vh;
    }
    
    .row.g-4 > [class*='col-'] {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    .page-header h2 {
        font-size: 1.1rem !important;
    }
    
    #heatmap-chart {
        height: 220px;
    }
    
    .heatmap-title {
        font-size: 1rem;
    }
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
    }
    to {
        transform: translateY(0);
    }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
    .modern-modal-backdrop,
    .modern-modal-content,
    .progress-fill {
        animation: none;
    }
}

/* Focus styles */
:focus-visible {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* Hidden utility */
.is-hidden {
    display: none !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Tableau de bord analytique -->
    <div id="analytics-dashboard" class="analytics-dashboard">
        <h2 class="dashboard-title mb-4 spectrum-Heading spectrum-Heading--sizeL">Tableau de bord analytique</h2>
        
        <!-- Contrôles de filtrage -->
        <div class="filter-controls mb-4">
            <div class="btn-group btn-group-toggle w-100" role="group" data-toggle="buttons">
                <button type="button" class="period-btn spectrum-Button spectrum-Button--secondary spectrum-Button--sizeM" data-period="7">
                    <i class="fas fa-calendar-week me-2"></i>7 jours
                </button>
                <button type="button" class="period-btn spectrum-Button spectrum-Button--secondary spectrum-Button--sizeM active" data-period="30">
                    <i class="far fa-calendar-alt me-2"></i>30 jours
                </button>
                <button type="button" class="period-btn spectrum-Button spectrum-Button--secondary spectrum-Button--sizeM" data-period="90">
                    <i class="fas fa-calendar-day me-2"></i>90 jours
                </button>
                <button type="button" class="period-btn spectrum-Button spectrum-Button--secondary spectrum-Button--sizeM" data-period="365">
                    <i class="fas fa-calendar me-2"></i>1 an
                </button>
            </div>
        </div>
        
        <!-- Indicateur de chargement -->
        <div id="analytics-loading" class="loading-spinner">
            <div class="spectrum-ProgressCircle spectrum-ProgressCircle--indeterminate spectrum-ProgressCircle--large" aria-label="Loading"></div>
        </div>
        
        <!-- Message d'erreur -->
        <div id="analytics-error" class="spectrum-InlineAlert spectrum-InlineAlert--negative" style="display: none;">
            <div class="spectrum-InlineAlert-content"></div>
        </div>
        
        <!-- Cartes de statistiques et graphique -->
        <div class="row g-4 mb-4 justify-content-center">
            <!-- Carte 1: Nombre de bons avec réception -->
            <div class="col-md-6 col-lg-4">
                <div class="spectrum-Card" style="width: 100%; height: 100%; background: #fff;">
                    <div class="spectrum-Card-body" style="padding: 24px;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="icon-shape icon-lg bg-soft-yellow text-yellow rounded-3 mb-3">
                                <i class="fas fa-file-invoice fa-lg"></i>
                            </div>
                            <span class="spectrum-Badge spectrum-Badge--sizeS spectrum-Badge--positive">Actif</span>
                        </div>
                        <h3 class="spectrum-Heading spectrum-Heading--sizeXXL spectrum-Heading--heavy mb-1" id="bons-avec-reception">0</h3>
                        <div class="spectrum-Detail spectrum-Detail--sizeM text-uppercase text-muted mb-3">Bons avec réception</div>
                        <p class="spectrum-Body spectrum-Body--sizeS text-muted m-0">
                            Bons de commande ayant au moins une réception enregistrée dans le système.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Carte 2: Total des bons de commande -->
            <div class="col-md-6 col-lg-4">
                <div class="spectrum-Card" style="width: 100%; height: 100%; background: #fff;">
                    <div class="spectrum-Card-body" style="padding: 24px;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="icon-shape icon-lg bg-soft-blue text-blue rounded-3 mb-3">
                                <i class="fas fa-clipboard-list fa-lg"></i>
                            </div>
                            <span class="spectrum-Badge spectrum-Badge--sizeS spectrum-Badge--neutral">Global</span>
                        </div>
                        <h3 class="spectrum-Heading spectrum-Heading--sizeXXL spectrum-Heading--heavy mb-1" id="total-bons">0</h3>
                        <div class="spectrum-Detail spectrum-Detail--sizeM text-uppercase text-muted mb-3">Total des bons</div>
                        <p class="spectrum-Body spectrum-Body--sizeS text-muted m-0">
                            Totalité des bons de commande importés et disponibles pour consultation.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Graphique: Diagramme circulaire -->
            <div class="col-12 col-lg-4">
                <div class="spectrum-Card" style="width: 100%; height: 100%; background: #fff;">
                    <div class="spectrum-Card-body d-flex flex-column" style="padding: 24px; height: 100%;">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-chart-pie text-warning me-2"></i>
                            <h5 class="spectrum-Heading spectrum-Heading--sizeXS text-uppercase text-muted m-0">Répartition</h5>
                        </div>
                        <div class="chart-container flex-grow-1" style="position: relative; min-height: 200px;">
                            <canvas id="pie-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Séparateur simple -->
    <div class="section-divider"></div>
    
    <div class="d-flex align-items-center justify-content-between mt-5 mb-4">
        <h4 class="page-header m-0">
            <i class="fas fa-search mr-2"></i> Delivery Report 
        </h4>
        <div class="text-muted small">
            <i class="fas fa-info-circle me-1"></i> Sélectionnez un bon pour voir les détails
        </div>
    </div>
    
    <!-- Filtre unique : liste déroulante des bons de commande -->
    <div class="row mb-4">
        <div class="col-md-5">
            <div class="form-group">
                <label for="bon-select" class="spectrum-FieldLabel mb-2">
                    Select a Purchase Order
                </label>
                <select id="bon-select" class="form-control select2" style="width: 100%;">
                    <option value="">All delivery orders</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Indicateur de chargement -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner-border text-warning" role="status">
            <span class="sr-only">Chargement...</span>
        </div>
    </div>
    
    <!-- Message si aucun résultat -->
    <div id="no-results" class="alert alert-info border-0 shadow-sm rounded-3" style="display: none; background-color: var(--spectrum-gray-50);">
        <div class="d-flex align-items-center">
            <i class="fas fa-info-circle me-3 fs-4 text-primary"></i>
            <div>
                <strong>No results found</strong><br>
                Try adjusting your search filters or selecting a different PO.
            </div>
        </div>
    </div>
    
    <!-- Tableau des résultats -->
    <div class="table-responsive mt-3">
        <table class="spectrum-Table">
            <thead>
                <tr>
                    <th class="spectrum-Table-headCell">Reception Number</th>
                    <th class="spectrum-Table-headCell">User</th>
                    <th class="spectrum-Table-headCell">Date</th>
                    <th class="spectrum-Table-headCell">Hour</th>
                    <th class="spectrum-Table-headCell">Delivery Rate</th>
                </tr>
            </thead>
            <tbody id="activity-logs-body" class="spectrum-Table-body">
                <!-- Les données seront insérées ici par JavaScript -->
            </tbody>
        </table>
    </div>
    
    <!-- Modal modernisé -->
    <div class="modern-modal" id="detailModal" aria-hidden="true" role="dialog" 
         aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-description" tabindex="-1">
        <div class="modern-modal-backdrop" aria-hidden="true"></div>
        
        <div class="modern-modal-dialog" role="document">
            <div class="modern-modal-content">
                <!-- En-tête -->
                <div class="modern-modal-header">
                    <div class="modal-header-main">
                        <div>
                            <h2 id="modal-title" class="modern-modal-title">Delivery Details</h2>
                            <p id="modal-description" class="modern-modal-subtitle">View delivery information and history</p>
                        </div>
                        <div class="modal-header-actions">
                            <button type="button" class="btn-icon" id="exportModalBtn" aria-label="Export to Excel" 
                                    data-tooltip="Export to Excel">
                                <svg width="20" height="20" fill="currentColor" aria-hidden="true">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm1.7 8.3l-2.3-3.1L11.7 10 10 8.3l2.3-3.1L10 2.1 11.7.8l2.3 3.1 2.3-3.1 1.7 1.3-2.3 3.1 2.3 3.1-1.7 1.3zM14 9V3.5L18.5 9H14z"/>
                                </svg>
                            </button>
                            <button type="button" class="btn-close" id="closeDetailModalBtn" aria-label="Close modal">
                                <svg width="20" height="20" fill="currentColor" aria-hidden="true">
                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Navigation par onglets -->
                    <nav class="modal-tabs" role="tablist" aria-label="Delivery information sections">
                        <button class="tab-btn active" role="tab" aria-selected="true" 
                                aria-controls="summary-panel" id="summary-tab" data-tab="summary">
                            <svg width="18" height="18" fill="currentColor" aria-hidden="true">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                            </svg>
                            <span>Summary</span>
                        </button>
                        <button class="tab-btn" role="tab" aria-selected="false" 
                                aria-controls="details-panel" id="details-tab" data-tab="details" tabindex="-1">
                            <svg width="18" height="18" fill="currentColor" aria-hidden="true">
                                <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                            </svg>
                            <span>Details</span>
                        </button>
                        <button class="tab-btn" role="tab" aria-selected="false" 
                                aria-controls="history-panel" id="history-tab" data-tab="history" tabindex="-1">
                            <svg width="18" height="18" fill="currentColor" aria-hidden="true">
                                <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                            </svg>
                            <span>History</span>
                        </button>
                    </nav>
                </div>

                <!-- Corps du modal -->
                <div class="modern-modal-body">
                    <!-- Panel Résumé -->
                    <section class="tab-panel active" id="summary-panel" role="tabpanel" 
                             aria-labelledby="summary-tab" tabindex="0">
                        <div class="stats-grid">
                            <!-- Carte Informations de commande -->
                            <div class="spectrum-Card" style="width: 100%; background: #f9fafb;">
                                <div class="spectrum-Card-body" style="padding: 20px;">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h3 class="spectrum-Heading spectrum-Heading--sizeXS my-0">Order Information</h3>
                                        <span class="spectrum-Badge spectrum-Badge--sizeS spectrum-Badge--positive" id="order-status-badge">Active</span>
                                    </div>
                                    <div class="d-flex flex-column gap-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="spectrum-Body spectrum-Body--sizeS text-muted">Ordered Quantity</span>
                                            <span class="spectrum-Body spectrum-Body--sizeS fw-bold" id="modal-total-amount">--</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="spectrum-Body spectrum-Body--sizeS text-muted">Quantity Delivered</span>
                                            <span class="spectrum-Body spectrum-Body--sizeS fw-bold" id="modal-amount-received">--</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="spectrum-Body spectrum-Body--sizeS text-muted">PO Amount</span>
                                            <span class="spectrum-Body spectrum-Body--sizeS fw-bold">
                                                <span id="modal-po-amount">--</span>
                                                <span class="text-muted fw-normal ms-1" id="modal-currency">USD</span>
                                            </span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="spectrum-Body spectrum-Body--sizeS text-muted">Line</span>
                                            <span class="spectrum-Body spectrum-Body--sizeS fw-bold" id="modal-line">--</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Carte Statut de livraison -->
                            <div class="spectrum-Card" style="width: 100%; background: #f9fafb;">
                                <div class="spectrum-Card-body" style="padding: 20px;">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h3 class="spectrum-Heading spectrum-Heading--sizeXS my-0">Delivery Status</h3>
                                        <div class="d-flex align-items-center">
                                            <span class="spectrum-Heading spectrum-Heading--sizeL me-1" id="modal-progress-rate">0</span>
                                            <span class="spectrum-Body spectrum-Body--sizeS text-muted">%</span>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-column gap-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="spectrum-Body spectrum-Body--sizeS text-muted">Amount Delivered</span>
                                            <span class="spectrum-Body spectrum-Body--sizeS fw-bold">
                                                <span id="modal-received-amount">--</span>
                                                <span class="text-muted fw-normal ms-1" id="modal-currency-2">USD</span>
                                            </span>
                                        </div>
                                        <div class="d-flex flex-column gap-2">
                                            <div class="d-flex justify-content-between">
                                                <span class="spectrum-Body spectrum-Body--sizeS text-muted">Delivery Rate</span>
                                                <span class="spectrum-Body spectrum-Body--sizeS fw-bold" id="modal-progress-rate-text">0%</span>
                                            </div>
                                            <div class="spectrum-ProgressBar spectrum-ProgressBar--sizeS" style="width: 100%; height: 6px; background: #e1e1e1; border-radius: 3px; overflow: hidden;">
                                                <div class="spectrum-ProgressBar-fill" id="progress-fill" style="width: 0%; height: 100%; background: #10b981; transition: width 0.3s ease;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Panel Détails -->
                    <section class="tab-panel" id="details-panel" role="tabpanel" 
                             aria-labelledby="details-tab" tabindex="0" hidden>
                        <div class="section-header">
                            <h3 class="section-title">Current Delivery</h3>
                            <div class="section-actions">
                                <button type="button" class="btn-sm btn-outline" id="filterDetailsBtn" aria-label="Filter details">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                                <button type="button" class="btn-sm btn-secondary" id="refreshDetailsBtn" aria-label="Refresh details">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-wrapper">
                            <div class="table-scroll">
                                <table class="data-table" aria-label="Current delivery details">
                                    <thead>
                                        <tr>
                                            <th scope="col">Reception #</th>
                                            <th scope="col">Order #</th>
                                            <th scope="col">Line Description</th>
                                            <th scope="col">Order Description</th>
                                            <th scope="col">Supplier</th>
                                            <th scope="col">Ordered</th>
                                            <th scope="col">Project #</th>
                                            <th scope="col">Task #</th>
                                            <th scope="col">Schedule</th>
                                            <th scope="col">Line</th>
                                            <th scope="col">Ordered Qty</th>
                                            <th scope="col">Delivered Qty</th>
                                            <th scope="col">Remaining Qty</th>
                                            <th scope="col">Price</th>
                                        </tr>
                                    </thead>
                                    <tbody id="current-reception-tbody">
                                        <!-- Rempli dynamiquement -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- Panel Historique -->
                    <section class="tab-panel" id="history-panel" role="tabpanel" 
                             aria-labelledby="history-tab" tabindex="0" hidden>
                        <div class="section-header">
                            <h3 class="section-title">Delivery History</h3>
                            <div class="section-actions">
                                <button type="button" class="btn-sm btn-outline" id="filterHistoryBtn" aria-label="Filter history">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table compact" aria-label="Delivery history">
                                <thead>
                                    <tr>
                                        <th scope="col">Date</th>
                                        <th scope="col">Order #</th>
                                        <th scope="col">Line</th>
                                        <th scope="col">Ordered Qty</th>
                                        <th scope="col">Delivered Qty</th>
                                        <th scope="col">Cumulative</th>
                                        <th scope="col">Remaining Qty</th>
                                    </tr>
                                </thead>
                                <tbody id="reception-history-body">
                                    <!-- Rempli dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <div class="modern-modal-footer">
                    <button type="button" class="btn btn-secondary" id="closeModalBtn">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Inclure Select2 JS -->
<script src="{% static 'js/vendor/select2.min.js' %}"></script>

<!-- Inclure Chart.js pour les graphiques -->
<script src="{% static 'js/vendor/chart.umd.min.js' %}"></script>

<!-- Inclure XLSX pour l'export Excel -->
<script src="{% static 'js/vendor/xlsx.full.min.js' %}"></script>

<!-- Variables pour les URLs Django -->
<script>
    // Définir les URLs pour les fichiers JS externes
    const getAllBonsUrl = '{% url "orders:get_all_bons" %}';
    const getActivityLogsUrl = '{% url "orders:get_activity_logs" %}';
    const getAnalyticsUrl = '{% url "orders:get_analytics_data" %}';
</script>

<!-- Inclure nos JS personnalisés -->
<script src="{% static 'orders/js/consultation.js' %}"></script>
<script src="{% static 'orders/js/analytics_dashboard.js' %}"></script>
<script src="{% static 'orders/js/custom_modal.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion du modal modernisé
    const modal = document.getElementById('detailModal');
    const closeBtn = document.getElementById('closeModalBtn');
    const closeBtn2 = document.getElementById('closeDetailModalBtn');
    const backdrop = document.querySelector('.modern-modal-backdrop');
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');
    const exportBtn = document.getElementById('exportModalBtn');

    // Fonctions pour ouvrir/fermer le modal
    window.openDetailModal = function(data) {
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Mettre à jour les données du modal
            if (data) {
                updateModalData(data);
                window.currentModalData = data;
                populateDetailsAndHistory(data);
            }
            
            // Focus sur le premier élément focusable
            setTimeout(() => {
                modal.querySelector('.tab-btn.active').focus();
            }, 100);
        }
    };

    window.closeDetailModal = function() {
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    };

    // Gestion des onglets
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            
            // Mettre à jour les boutons d'onglets
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
                btn.removeAttribute('tabindex');
            });
            
            this.classList.add('active');
            this.setAttribute('aria-selected', 'true');
            
            // Mettre à jour les panels
            tabPanels.forEach(panel => {
                panel.hidden = true;
                panel.classList.remove('active');
            });
            
            const targetPanel = document.getElementById(`${tabId}-panel`);
            if (targetPanel) {
                targetPanel.hidden = false;
                targetPanel.classList.add('active');
                targetPanel.focus();
            }
        });
        
        // Navigation au clavier pour les onglets
        button.addEventListener('keydown', function(e) {
            const currentIndex = Array.from(tabButtons).indexOf(this);
            
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                const nextIndex = (currentIndex + 1) % tabButtons.length;
                tabButtons[nextIndex].focus();
                tabButtons[nextIndex].click();
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                const prevIndex = (currentIndex - 1 + tabButtons.length) % tabButtons.length;
                tabButtons[prevIndex].focus();
                tabButtons[prevIndex].click();
            } else if (e.key === 'Home') {
                e.preventDefault();
                tabButtons[0].focus();
                tabButtons[0].click();
            } else if (e.key === 'End') {
                e.preventDefault();
                tabButtons[tabButtons.length - 1].focus();
                tabButtons[tabButtons.length - 1].click();
            }
        });
    });

    // Fermeture du modal
    [closeBtn, closeBtn2, backdrop].forEach(element => {
        if (element) {
            element.addEventListener('click', closeDetailModal);
        }
    });

    // Gestion de la touche Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeDetailModal();
        }
        
        // Navigation par tab dans le modal
        if (e.key === 'Tab' && modal.classList.contains('active')) {
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];
            
            if (e.shiftKey && document.activeElement === firstElement) {
                e.preventDefault();
                lastElement.focus();
            } else if (!e.shiftKey && document.activeElement === lastElement) {
                e.preventDefault();
                firstElement.focus();
            }
        }
    });

    // Gestion de l'export Excel
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            if (typeof exportToExcel === 'function') {
                exportToExcel();
            } else {
                console.warn('exportToExcel function not found');
            }
        });
    }

    // Fonction pour mettre à jour les données du modal
    function updateModalData(log) {
        // Résumé
        if (log.ordered_quantity !== undefined) {
            document.getElementById('modal-total-amount').textContent = parseFloat(log.ordered_quantity).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        if (log.cumulative_recipe !== undefined) {
            document.getElementById('modal-amount-received').textContent = parseFloat(log.cumulative_recipe || 0).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        if (log.po_amount !== undefined) {
            document.getElementById('modal-po-amount').textContent = parseFloat(log.po_amount).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        if (log.currency) {
            document.getElementById('modal-currency').textContent = log.currency;
            document.getElementById('modal-currency-2').textContent = log.currency;
        }
        if (log.line) {
            document.getElementById('modal-line').textContent = log.line;
        }
        if (log.received_amount !== undefined) {
            document.getElementById('modal-received-amount').textContent = parseFloat(log.received_amount).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        if (log.progress_rate !== undefined) {
            const pr = parseFloat(log.progress_rate).toFixed(2);
            document.getElementById('modal-progress-rate').textContent = pr;
            document.getElementById('modal-progress-rate-text').textContent = `${pr}%`;
            document.getElementById('progress-fill').style.width = `${pr}%`;
            document.getElementById('progress-fill').parentElement.setAttribute('aria-valuenow', pr);
        }
        // Statut
        const badge = document.getElementById('order-status-badge');
        if (badge) {
            const status = log.status || 'Active';
            updateBadgeStatus(badge, status);
        }
    }
    
    function populateDetailsAndHistory(log) {
        const tbody = document.getElementById('current-reception-tbody');
        if (tbody) {
            tbody.innerHTML = '';
            const prev = (log.previous_receptions || []).sort((a, b) => new Date(a.action_date) - new Date(b.action_date));
            prev.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.reception_number || 'N/A'}</td>
                    <td>${r.bon_commande || 'N/A'}</td>
                    <td>${r.line_description || 'N/A'}</td>
                    <td>${r.order_description || 'N/A'}</td>
                    <td>${r.supplier || 'N/A'}</td>
                    <td>${r.ordered_date || 'N/A'}</td>
                    <td>${r.project_number || 'N/A'}</td>
                    <td>${r.task_number || 'N/A'}</td>
                    <td>${r.schedule || 'N/A'}</td>
                    <td>${r.line || 'N/A'}</td>
                    <td>${parseFloat(r.ordered_quantity || 0).toFixed(2)}</td>
                    <td>${parseFloat(r.cumulative_recipe || 0).toFixed(2)}</td>
                    <td>${parseFloat(r.quantity_not_delivered || 0).toFixed(2)}</td>
                    <td>${parseFloat(r.price || 0).toFixed(2)} ${log.currency || 'USD'}</td>
                `;
                tbody.appendChild(tr);
            });
            const tr = document.createElement('tr');
            tr.classList.add('table-primary');
            tr.innerHTML = `
                <td>${log.reception_number || 'N/A'}</td>
                <td>${log.bon_commande || 'N/A'}</td>
                <td>${log.line_description || 'N/A'}</td>
                <td>${log.order_description || 'N/A'}</td>
                <td>${log.supplier || 'N/A'}</td>
                <td>${log.ordered_date || 'N/A'}</td>
                <td>${log.project_number || 'N/A'}</td>
                <td>${log.task_number || 'N/A'}</td>
                <td>${log.schedule || 'N/A'}</td>
                <td>${log.line || 'N/A'}</td>
                <td>${parseFloat(log.ordered_quantity || 0).toFixed(2)}</td>
                <td>${parseFloat(log.cumulative_recipe || 0).toFixed(2)}</td>
                <td>${parseFloat(log.quantity_not_delivered || 0).toFixed(2)}</td>
                <td>${parseFloat(log.price || 0).toFixed(2)} ${log.currency || 'USD'}</td>
            `;
            tbody.appendChild(tr);
        }
        const hbody = document.getElementById('reception-history-body');
        if (hbody) {
            hbody.innerHTML = '';
            const list = (log.line_receptions || []).sort((a, b) => new Date(a.date) - new Date(b.date));
            if (list.length) {
                list.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${r.date || 'N/A'}</td>
                        <td>${r.order || 'N/A'}</td>
                        <td>${r.line || 'N/A'}</td>
                        <td>${parseFloat(r.ordered_quantity || 0).toFixed(2)}</td>
                        <td>${parseFloat(r.quantity_delivered || 0).toFixed(2)}</td>
                        <td>${r.cumulative_recipe === 0 || r.cumulative_recipe === '0' ? '0.00' : (r.cumulative_recipe !== null && r.cumulative_recipe !== undefined ? parseFloat(r.cumulative_recipe).toFixed(2) : 'N/A')}</td>
                        <td>${parseFloat(r.quantity_not_delivered || 0).toFixed(2)}</td>
                    `;
                    hbody.appendChild(tr);
                });
            } else {
                hbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No previous receptions found</td></tr>';
            }
        }
    }

    function updateBadgeStatus(element, status) {
        // Remove all semantic variants
        element.classList.remove(
            'spectrum-Badge--positive',
            'spectrum-Badge--negative',
            'spectrum-Badge--info',
            'spectrum-Badge--neutral',
            'spectrum-Badge--yellow'
        );
        
        // Remove inline background style if any (legacy cleanup)
        element.style.background = '';
        
        element.textContent = status;

        switch (status) {
            case 'Active':
                element.classList.add('spectrum-Badge--positive');
                break;
            case 'Completed':
                element.classList.add('spectrum-Badge--positive');
                break;
            case 'Pending':
                element.classList.add('spectrum-Badge--yellow');
                break;
            case 'Cancelled':
                element.classList.add('spectrum-Badge--negative');
                break;
            default:
                element.classList.add('spectrum-Badge--neutral');
        }
    }

    // Initialiser Select2
    $('#bon-select').select2({
        theme: 'bootstrap4',
        placeholder: 'Select a purchase order...',
        allowClear: true,
        width: '100%'
    });
});
</script>
{% endblock %}
