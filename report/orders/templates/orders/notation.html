{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Vendor Evaluation - {{ bon_commande.numero }} | Performance Assessment{% endblock %}

{% block extra_css %}
<style>
    :root {
        --spectrum-black: #000000;
        --spectrum-yellow: #FFCC00;
        --spectrum-gray-50: #FAFAFA;
        --spectrum-gray-100: #F5F5F5;
        --spectrum-gray-200: #EAEAEA;
        --spectrum-gray-800: #424242;
        --spectrum-green: #30A46C;
        --spectrum-orange: #FF8B29;
        --spectrum-red: #E5484D;
        --spectrum-blue: #2680EB;
        --spectrum-purple: #8E44D6;
    }

    .evaluation-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .spectrum-page-header {
        background: white;
        border-bottom: 1px solid var(--spectrum-gray-200);
        padding: 2rem 0;
        margin-bottom: 2rem;
    }

    .page-header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 2rem;
    }

    .header-title {
        flex: 1;
    }

    .header-badge {
        background: var(--spectrum-yellow);
        color: var(--spectrum-black);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.875rem;
    }

    .spectrum-card {
        background: white;
        border-radius: 12px;
        border: 1px solid var(--spectrum-gray-200);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .card-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--spectrum-gray-200);
        background: var(--spectrum-gray-50);
    }

    .card-header h3 {
        margin: 0;
        font-weight: 600;
        font-size: 1.25rem;
        color: var(--spectrum-black);
    }

    .card-body {
        padding: 1.5rem;
    }

    .po-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .info-card {
        background: var(--spectrum-gray-50);
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid var(--spectrum-gray-200);
    }

    .info-label {
        font-size: 0.875rem;
        color: var(--spectrum-gray-800);
        font-weight: 500;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--spectrum-black);
    }

    .info-subvalue {
        font-size: 0.875rem;
        color: var(--spectrum-gray-800);
        margin-top: 0.25rem;
    }

    .evaluation-form {
        margin-top: 2rem;
    }

    .criteria-grid {
        display: grid;
        gap: 1.5rem;
    }

    .criteria-card {
        background: white;
        border-radius: 8px;
        border: 1px solid var(--spectrum-gray-200);
        padding: 1.5rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .criteria-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    .criteria-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
    }

    .criteria-title {
        flex: 1;
    }

    .criteria-name {
        font-weight: 600;
        font-size: 1.125rem;
        color: var(--spectrum-black);
        margin-bottom: 0.5rem;
    }

    .criteria-max {
        font-size: 0.875rem;
        color: var(--spectrum-gray-800);
    }

    .score-selector {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .score-value {
        min-width: 60px;
        text-align: center;
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--spectrum-black);
    }

    .score-slider {
        flex: 1;
        -webkit-appearance: none;
        appearance: none;
        height: 8px;
        background: var(--spectrum-gray-200);
        border-radius: 4px;
        outline: none;
    }

    .score-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--spectrum-black);
        cursor: pointer;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease;
    }

    .score-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
    }

    .score-slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--spectrum-black);
        cursor: pointer;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .score-options {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }

    .score-option {
        padding: 0.5rem 1rem;
        background: var(--spectrum-gray-100);
        border: 1px solid var(--spectrum-gray-200);
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .score-option:hover {
        background: var(--spectrum-gray-200);
    }

    .score-option.active {
        background: var(--spectrum-black);
        color: white;
        border-color: var(--spectrum-black);
    }

    .criteria-description {
        background: var(--spectrum-gray-50);
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        border-left: 4px solid var(--spectrum-blue);
    }

    .description-text {
        font-size: 0.9375rem;
        color: var(--spectrum-gray-800);
        line-height: 1.6;
        margin: 0;
    }

    .score-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .summary-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        border: 1px solid var(--spectrum-gray-200);
    }

    .summary-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        color: var(--spectrum-black);
        margin-bottom: 0.5rem;
    }

    .summary-label {
        font-size: 0.875rem;
        color: var(--spectrum-gray-800);
        font-weight: 500;
    }

    .summary-progress {
        height: 6px;
        background: var(--spectrum-gray-200);
        border-radius: 3px;
        margin-top: 1rem;
        overflow: hidden;
    }

    .summary-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--spectrum-gray-200);
    }

    .spectrum-button {
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        border: 2px solid transparent;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.9375rem;
    }

    .spectrum-button-primary {
        background: var(--spectrum-black);
        color: white;
    }

    .spectrum-button-primary:hover {
        background: #333;
        color: white;
    }

    .spectrum-button-secondary {
        background: white;
        color: var(--spectrum-gray-800);
        border-color: var(--spectrum-gray-200);
    }

    .spectrum-button-secondary:hover {
        background: var(--spectrum-gray-50);
        border-color: var(--spectrum-gray-800);
    }

    .spectrum-button-action {
        background: var(--spectrum-yellow);
        color: var(--spectrum-black);
        border: 2px solid var(--spectrum-yellow);
        font-weight: 700;
        transition: all 0.2s ease;
    }

    .spectrum-button-action:hover {
        background: var(--spectrum-blue);
        color: white;
        border-color: var(--spectrum-blue);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .score-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .score-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 100px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge-excellent {
        background: var(--spectrum-green);
        color: white;
    }

    .badge-good {
        background: var(--spectrum-yellow);
        color: var(--spectrum-black);
    }

    .badge-average {
        background: var(--spectrum-orange);
        color: white;
    }

    .badge-poor {
        background: var(--spectrum-red);
        color: white;
    }

    .validation-message {
        background: var(--spectrum-red);
        color: white;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1.5rem;
        display: none;
    }

    .validation-message.show {
        display: block;
    }

    .completion-indicator {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .completion-bar {
        flex: 1;
        height: 6px;
        background: var(--spectrum-gray-200);
        border-radius: 3px;
        overflow: hidden;
    }

    .completion-fill {
        height: 100%;
        background: var(--spectrum-yellow);
        transition: width 0.3s ease;
    }

    @media (max-width: 768px) {
        .page-header-content {
            flex-direction: column;
        }
        
        .criteria-header {
            flex-direction: column;
            gap: 1rem;
        }
        
        .score-selector {
            width: 100%;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .spectrum-button {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="evaluation-container">
    <!-- Page Header -->
    <div class="spectrum-page-header">
        <div class="container">
            <div class="page-header-content">
                <div class="header-title">
                    <h1 class="h2 mb-2" style="font-weight: 700;">Vendor Performance Evaluation</h1>
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <div class="header-badge">PO #{{ bon_commande.numero }}</div>
                        <div class="text-muted">Complete all criteria below to evaluate supplier performance</div>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="completion-indicator">
                        <div class="completion-bar">
                            <div class="completion-fill" id="completionFill" style="width: 0%"></div>
                        </div>
                        <div class="text-muted small" id="completionText">0% Complete</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Validation Message -->
        <div class="validation-message" id="validationMessage">
            <i class="fas fa-exclamation-circle me-2"></i>
            Please complete all evaluation criteria before submitting.
        </div>

        <!-- PO Information -->
        <div class="spectrum-card">
            <div class="card-header">
                <h3><i class="fas fa-file-invoice me-2"></i> Purchase Order Information</h3>
            </div>
            <div class="card-body">
                <div class="po-info-grid">
                    <div class="info-card">
                        <div class="info-label">Supplier</div>
                        <div class="info-value">{{ supplier }}</div>
                        <div class="info-subvalue">Contract Partner</div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-label">Order Value</div>
                        <div class="info-value">{{ bon_commande.montant_total|floatformat:0|intcomma }} {{ bon_commande.get_currency }}</div>
                        <div class="info-subvalue">Total Contract Value</div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-label">Delivery Progress</div>
                        <div class="info-value">{{ bon_commande.taux_avancement|floatformat:2 }}%</div>
                        <div class="info-subvalue">Order Completion</div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-label">Evaluation Type</div>
                        <div class="info-value">Periodic Review</div>
                        <div class="info-subvalue">Standard Assessment</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Score Summary -->
        <div class="spectrum-card">
            <div class="card-header">
                <h3><i class="fas fa-chart-line me-2"></i> Performance Summary</h3>
            </div>
            <div class="card-body">
                <div class="score-summary-grid">
                    <div class="summary-card">
                        <div class="summary-value" id="totalScore">0</div>
                        <div class="summary-label">Total Score</div>
                        <div class="summary-progress">
                            <div class="summary-fill" id="totalScoreFill" 
                                 style="width: 0%; background: var(--spectrum-gray-800);"></div>
                        </div>
                        <div class="score-indicator">
                            <span class="score-badge" id="totalScoreBadge">Not Rated</span>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-value" id="vendorRating">0.0</div>
                        <div class="summary-label">Average Rating</div>
                        <div class="summary-progress">
                            <div class="summary-fill" id="ratingFill" 
                                 style="width: 0%; background: var(--spectrum-gray-800);"></div>
                        </div>
                        <div class="score-indicator">
                            <div class="rating-stars">
                                <span>★</span><span>★</span><span>★</span><span>★</span><span>★</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-value" id="completionRate">0%</div>
                        <div class="summary-label">Completion</div>
                        <div class="summary-progress">
                            <div class="summary-fill" id="completionFillBar" 
                                 style="width: 0%; background: var(--spectrum-yellow);"></div>
                        </div>
                        <div class="score-indicator">
                            <span class="text-muted small" id="completedCriteria">0/5 criteria</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Evaluation Form -->
        <form method="post" id="evaluationForm" class="evaluation-form">
            {% csrf_token %}
            
            <div class="spectrum-card">
                <div class="card-header">
                    <h3><i class="fas fa-clipboard-check me-2"></i> Evaluation Criteria</h3>
                    <small class="text-muted">Rate each criteria from 0 (Poor) to 10 (Excellent)</small>
                </div>
                <div class="card-body">
                    <div class="criteria-grid">
                        
                        <!-- Delivery Compliance -->
                        <div class="criteria-card">
                            <div class="criteria-header">
                                <div class="criteria-title">
                                    <div class="criteria-name">Delivery Compliance to Order</div>
                                    <div class="criteria-max">Quantity & Quality Assessment</div>
                                </div>
                                <div class="score-selector">
                                    <input type="range" class="score-slider" name="delivery_compliance" 
                                           min="0" max="10" step="1" 
                                           value="{{ evaluation.delivery_compliance|default:'0' }}"
                                           data-criteria="delivery_compliance">
                                    <div class="score-value" id="score_delivery_compliance">
                                        {{ evaluation.delivery_compliance|default:'0' }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="score-options">
                                {% for i in "012345678910"|make_list %}
                                <div class="score-option" data-criteria="delivery_compliance" data-value="{{ i }}">
                                    {{ i }}
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="criteria-description">
                                <p class="description-text" id="desc_delivery_compliance">
                                    Select a score to see detailed description
                                </p>
                            </div>
                        </div>
                        
                        <!-- Delivery Timeline -->
                        <div class="criteria-card">
                            <div class="criteria-header">
                                <div class="criteria-title">
                                    <div class="criteria-name">Delivery Execution Timeline</div>
                                    <div class="criteria-max">Schedule Adherence</div>
                                </div>
                                <div class="score-selector">
                                    <input type="range" class="score-slider" name="delivery_timeline" 
                                           min="0" max="10" step="1" 
                                           value="{{ evaluation.delivery_timeline|default:'0' }}"
                                           data-criteria="delivery_timeline">
                                    <div class="score-value" id="score_delivery_timeline">
                                        {{ evaluation.delivery_timeline|default:'0' }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="score-options">
                                {% for i in "012345678910"|make_list %}
                                <div class="score-option" data-criteria="delivery_timeline" data-value="{{ i }}">
                                    {{ i }}
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="criteria-description">
                                <p class="description-text" id="desc_delivery_timeline">
                                    Select a score to see detailed description
                                </p>
                            </div>
                        </div>
                        
                        <!-- Advising Capability -->
                        <div class="criteria-card">
                            <div class="criteria-header">
                                <div class="criteria-title">
                                    <div class="criteria-name">Vendor Advising Capability</div>
                                    <div class="criteria-max">Expertise & Guidance</div>
                                </div>
                                <div class="score-selector">
                                    <input type="range" class="score-slider" name="advising_capability" 
                                           min="0" max="10" step="1" 
                                           value="{{ evaluation.advising_capability|default:'0' }}"
                                           data-criteria="advising_capability">
                                    <div class="score-value" id="score_advising_capability">
                                        {{ evaluation.advising_capability|default:'0' }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="score-options">
                                {% for i in "012345678910"|make_list %}
                                <div class="score-option" data-criteria="advising_capability" data-value="{{ i }}">
                                    {{ i }}
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="criteria-description">
                                <p class="description-text" id="desc_advising_capability">
                                    Select a score to see detailed description
                                </p>
                            </div>
                        </div>
                        
                        <!-- After Sales QOS -->
                        <div class="criteria-card">
                            <div class="criteria-header">
                                <div class="criteria-title">
                                    <div class="criteria-name">After Sales Services QOS</div>
                                    <div class="criteria-max">Post-Delivery Support</div>
                                </div>
                                <div class="score-selector">
                                    <input type="range" class="score-slider" name="after_sales_qos" 
                                           min="0" max="10" step="1" 
                                           value="{{ evaluation.after_sales_qos|default:'0' }}"
                                           data-criteria="after_sales_qos">
                                    <div class="score-value" id="score_after_sales_qos">
                                        {{ evaluation.after_sales_qos|default:'0' }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="score-options">
                                {% for i in "012345678910"|make_list %}
                                <div class="score-option" data-criteria="after_sales_qos" data-value="{{ i }}">
                                    {{ i }}
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="criteria-description">
                                <p class="description-text" id="desc_after_sales_qos">
                                    Select a score to see detailed description
                                </p>
                            </div>
                        </div>
                        
                        <!-- Vendor Relationship -->
                        <div class="criteria-card">
                            <div class="criteria-header">
                                <div class="criteria-title">
                                    <div class="criteria-name">Vendor Relationship</div>
                                    <div class="criteria-max">Communication & Responsiveness</div>
                                </div>
                                <div class="score-selector">
                                    <input type="range" class="score-slider" name="vendor_relationship" 
                                           min="0" max="10" step="1" 
                                           value="{{ evaluation.vendor_relationship|default:'0' }}"
                                           data-criteria="vendor_relationship">
                                    <div class="score-value" id="score_vendor_relationship">
                                        {{ evaluation.vendor_relationship|default:'0' }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="score-options">
                                {% for i in "012345678910"|make_list %}
                                <div class="score-option" data-criteria="vendor_relationship" data-value="{{ i }}">
                                    {{ i }}
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="criteria-description">
                                <p class="description-text" id="desc_vendor_relationship">
                                    Select a score to see detailed description
                                </p>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="submit" class="spectrum-button spectrum-button-action flex-fill">
                    <i class="fas fa-save me-2"></i> Save Evaluation
                </button>
                {% if fichier_id %}
                <a href="{% url 'orders:details_bon' bon_id=fichier_id %}?selected_order_number={{ bon_commande.numero }}" 
                   class="spectrum-button spectrum-button-secondary flex-fill">
                    <i class="fas fa-times me-2"></i> Cancel & Return to PO
                </a>
                {% else %}
                <a href="{% url 'orders:accueil' %}" 
                   class="spectrum-button spectrum-button-secondary flex-fill">
                    <i class="fas fa-times me-2"></i> Cancel
                </a>
                {% endif %}
                <a href="{% url 'orders:vendor_evaluation_list' %}" 
                   class="spectrum-button spectrum-button-primary flex-fill">
                    <i class="fas fa-list me-2"></i> View All Evaluations
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Critères et descriptions (mêmes données que précédemment)
const criteriaDescriptions = {
    'delivery_compliance': {
        0: 'Non conforme',
        1: 'Non conforme',
        2: 'Conformité : 25% par rapport au besoin exprimé',
        3: 'Conformité : 25% par rapport au besoin exprimé',
        4: 'Conformité : 25% par rapport au besoin exprimé',
        5: 'Conformité : 50% par rapport au besoin exprimé',
        6: 'Conformité : 50% par rapport au besoin exprimé',
        7: 'Conforme au besoin',
        8: 'Conforme au besoin',
        9: 'Conforme au besoin',
        10: 'Supérieure / Meilleur que le besoin exprimé par MTN CI mais au même coût'
    },
    'delivery_timeline': {
        0: 'Aucune livraison effectuée',
        1: 'Aucune livraison effectuée',
        2: 'Retard dans la livraison sans le notifier à MTN CI',
        3: 'Retard dans la livraison sans le notifier à MTN CI',
        4: 'Retard négocié avec MTN CI et non respect du nouveau planning avec explication donné à MTN',
        5: 'Retard négocié avec MTN CI et non respect du nouveau planning avec explication donné à MTN',
        6: 'Retard négocié avec MTN CI et non respect du nouveau planning avec explication donné à MTN',
        7: 'Respect des délais',
        8: 'Respect des délais',
        9: 'Respect des délais',
        10: 'En avance sur le délai de livraison prévue'
    },
    'advising_capability': {
        0: 'Conseil inexistant',
        1: 'Conseil inexistant',
        2: 'Sur demande de MTN CI - Conseil donné mais pas utile',
        3: 'Sur demande de MTN CI - Conseil donné mais pas utile',
        4: 'Sur demande de MTN CI - Conseil donné utile mais incomplet',
        5: 'Sur demande de MTN CI - Conseil donné utile mais incomplet',
        6: 'Sur demande de MTN CI - Conseil donné utile mais incomplet',
        7: 'Capacité à conseiller répond à nos attentes',
        8: 'Capacité à conseiller répond à nos attentes',
        9: 'Capacité à conseiller répond à nos attentes',
        10: 'Transfert de compétence & formation régulière du client'
    },
    'after_sales_qos': {
        0: 'SAV inexistant',
        1: 'SAV inexistant',
        2: 'Pas adapté à nos attentes',
        3: 'Pas adapté à nos attentes',
        4: 'Adapté à 50% à nos attentes sans respecter les délais',
        5: 'Adapté à 50% à nos attentes sans respecter les délais',
        6: 'Adapté à 50% à nos attentes sans respecter les délais',
        7: '100% des requêtes et des plaintes résolues dans les délais',
        8: '100% des requêtes et des plaintes résolues dans les délais',
        9: '100% des requêtes et des plaintes résolues dans les délais',
        10: 'Anticipation des problèmes / Aucun incident n\'est à signaler'
    },
    'vendor_relationship': {
        0: 'Aucun contact',
        1: 'Aucun contact',
        2: 'Injoignable en dehors des visites / événements / pendant l\'exécution d\'une commande',
        3: 'Injoignable en dehors des visites / événements / pendant l\'exécution d\'une commande',
        4: 'Joignable après 2 ou 3 jours de relance, rappels …',
        5: 'Joignable après 2 ou 3 jours de relance, rappels …',
        6: 'Joignable après 2 ou 3 jours de relance, rappels …',
        7: 'Bon contact / Prestataire réactif',
        8: 'Bon contact / Prestataire réactif',
        9: 'Bon contact / Prestataire réactif',
        10: 'Bon contact / Prestataire très réactif'
    }
};

// Fonction pour mettre à jour la description
function updateDescription(criteria, score) {
    const descElement = document.getElementById(`desc_${criteria}`);
    if (score === '' || score === null || score === '0') {
        descElement.textContent = 'Select a score to see detailed description';
    } else {
        const description = criteriaDescriptions[criteria][parseInt(score)];
        descElement.textContent = description || `Score: ${score}`;
    }
}

// Fonction pour mettre à jour le score visuel
function updateScoreValue(criteria, value) {
    const scoreElement = document.getElementById(`score_${criteria}`);
    const slider = document.querySelector(`[name="${criteria}"]`);
    const options = document.querySelectorAll(`.score-option[data-criteria="${criteria}"]`);
    
    scoreElement.textContent = value;
    slider.value = value;
    
    // Mettre à jour les options actives
    options.forEach(option => {
        option.classList.remove('active');
        if (parseInt(option.dataset.value) === parseInt(value)) {
            option.classList.add('active');
        }
    });
    
    // Mettre à jour la description
    updateDescription(criteria, value);
}

// Fonction pour calculer et afficher les scores
function updateScoreSummary() {
    const criteria = ['delivery_compliance', 'delivery_timeline', 'advising_capability', 'after_sales_qos', 'vendor_relationship'];
    let totalScore = 0;
    let completedCriteria = 0;
    let hasZeroScore = false;
    
    criteria.forEach(criteriaName => {
        const slider = document.querySelector(`[name="${criteriaName}"]`);
        const value = parseInt(slider.value);
        
        if (!isNaN(value) && value > 0) {
            totalScore += value;
            completedCriteria++;
        } else if (value === 0) {
            hasZeroScore = true;
            completedCriteria++; // 0 est une note valide
        }
    });
    
    const vendorRating = completedCriteria > 0 ? (totalScore / completedCriteria) : 0;
    const completionRate = (completedCriteria / criteria.length) * 100;
    const totalScorePercentage = (totalScore / 50) * 100;
    const ratingPercentage = (vendorRating / 10) * 100;
    
    // Mettre à jour les éléments UI
    document.getElementById('totalScore').textContent = totalScore;
    document.getElementById('vendorRating').textContent = vendorRating.toFixed(1);
    document.getElementById('completionRate').textContent = `${completionRate.toFixed(0)}%`;
    document.getElementById('completedCriteria').textContent = `${completedCriteria}/5 criteria`;
    
    document.getElementById('totalScoreFill').style.width = `${totalScorePercentage}%`;
    document.getElementById('ratingFill').style.width = `${ratingPercentage}%`;
    document.getElementById('completionFillBar').style.width = `${completionRate}%`;
    document.getElementById('completionFill').style.width = `${completionRate}%`;
    document.getElementById('completionText').textContent = `${completionRate.toFixed(0)}% Complete`;
    
    // Mettre à jour le badge du score total
    const totalScoreBadge = document.getElementById('totalScoreBadge');
    if (totalScore >= 40) {
        totalScoreBadge.className = 'score-badge badge-excellent';
        totalScoreBadge.textContent = 'Excellent';
    } else if (totalScore >= 30) {
        totalScoreBadge.className = 'score-badge badge-good';
        totalScoreBadge.textContent = 'Good';
    } else if (totalScore >= 20) {
        totalScoreBadge.className = 'score-badge badge-average';
        totalScoreBadge.textContent = 'Average';
    } else {
        totalScoreBadge.className = 'score-badge badge-poor';
        totalScoreBadge.textContent = 'Needs Improvement';
    }
    
    // Mettre à jour les étoiles
    const stars = document.querySelectorAll('.rating-stars span');
    const starRating = Math.round(vendorRating / 2); // Convertir 0-10 à 0-5 étoiles
    stars.forEach((star, index) => {
        if (index < starRating) {
            star.textContent = '★';
            star.style.color = 'var(--spectrum-yellow)';
        } else {
            star.textContent = '☆';
            star.style.color = 'var(--spectrum-gray-200)';
        }
    });
    
    return completedCriteria === criteria.length;
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser les sliders
    const sliders = document.querySelectorAll('.score-slider');
    sliders.forEach(slider => {
        const criteria = slider.name;
        const initialValue = slider.value;
        
        // Mettre à jour l'affichage initial
        updateScoreValue(criteria, initialValue);
        updateDescription(criteria, initialValue);
        
        // Événement de changement sur le slider
        slider.addEventListener('input', function() {
            updateScoreValue(criteria, this.value);
            updateScoreSummary();
        });
    });
    
    // Initialiser les boutons d'options
    const scoreOptions = document.querySelectorAll('.score-option');
    scoreOptions.forEach(option => {
        option.addEventListener('click', function() {
            const criteria = this.dataset.criteria;
            const value = this.dataset.value;
            updateScoreValue(criteria, value);
            updateScoreSummary();
        });
    });
    
    // Initialiser le résumé
    updateScoreSummary();
    
    // Validation du formulaire
    document.getElementById('evaluationForm').addEventListener('submit', function(e) {
        const allComplete = updateScoreSummary();
        
        if (!allComplete) {
            e.preventDefault();
            const validationMessage = document.getElementById('validationMessage');
            validationMessage.classList.add('show');
            validationMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Masquer le message après 5 secondes
            setTimeout(() => {
                validationMessage.classList.remove('show');
            }, 5000);
        }
    });
    
    // Masquer le message de validation en cliquant dessus
    document.getElementById('validationMessage').addEventListener('click', function() {
        this.classList.remove('show');
    });
});
</script>
{% endblock %}